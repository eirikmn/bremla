---
output: github_document
---

<!-- Paper_results_2.md is generated from paper_results_2.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/results2-",
  dev = "png",
  out.width = "80%"
)
```

# bremla

This file includes the data and code needed to reproduce the results for

Myrvoll-Nilsen, E., Riechers, K. & Boers, N. (202x). Tie-point paper (title TBD)

# Myrvoll-Nilsen et al. (202x)

The data used is the NGRIP/GICC05 data set 'NGRIP_d18O_and_dust_5cm', downloaded from [Centre for Ice and Climate](iceandclimate.nbi.ku.dk) at the Niels Bohr Institute of the University of Copenhagen, Denmark, and the table of stadial-interstadial events presented by [Rasmussen et al. (2014)](https://www.sciencedirect.com/science/article/pii/S0277379114003485). These are included in the package and can be imported as follows. 
```{r initialize, eval=FALSE}
#library(bremla)
data("event_intervals")
data("events_rasmussen")
data("NGRIP_5cm")
age = NGRIP_5cm$age
depth = NGRIP_5cm$depth
proxy = NGRIP_5cm$d18O
n=length(diff(age))
data = data.frame(age=age,dy=c(NA,diff(age)),depth=depth,depth2=depth^2,proxy=proxy)
events=list(locations = events_rasmussen$depth,
            locations_unit="depth",degree=1)
# plot(depth,proxy,xlab="Age (yb2k)",ylab=expression(paste(d^18,"O (permil)")),type="l",
     # xlim=rev(range(depth)))+abline(v=events$locations,col="gray",lwd=0.7)
formula = dy~-1+depth2+proxy
```


We also use tie-points described by probability distributions obtained from Adolphi et al. (2018) and Muscheler et al. (2020). These can be imported as follows.

```{r adolphi, eval=TRUE}
library(ggplot2)
x.ref=c(11050,12050,13050,22050,42050)
adolphipdfs = adolphiloader(tieshifts=c(11050,12050,13050,22050,42050),plotdens = FALSE,
                            x.ref=x.ref)
lower = c(-77.53, -30.92, -12.37, 336.19, 101.51)+x.ref
upper = c(-41.09, 11.94, 21.99, 714.03, 509.08)+x.ref
means = c(-59.95, -7.04, 3.34, 521.44, 275.24)+x.ref
medians = c(-60.10, -6.42, 2.64, 532.36, 243.57)+x.ref
gg1 = ggplot(data=adolphipdfs$tie1,aes(x=x,y=y))+geom_line()+theme_bw()+xlab("GICC05 age (yb2k)")+
  ggtitle("Tie-point 1") + ylab("Density") + 
  geom_vline(aes(xintercept=x.ref[1]),color="black")+
  geom_vline(aes(xintercept=means[1]),color="blue")+
  geom_vline(aes(xintercept=lower[1]),color="red")+
  geom_vline(aes(xintercept=upper[1]),color="red")
gg2 = ggplot(data=adolphipdfs$tie2,aes(x=x,y=y))+geom_line()+theme_bw()+xlab("GICC05 age (yb2k)")+
  ggtitle("Tie-point 2") + ylab("Density") + 
  geom_vline(aes(xintercept=x.ref[2]),color="black")+
  geom_vline(aes(xintercept=means[2]),color="blue")+
  geom_vline(aes(xintercept=lower[2]),color="red")+
  geom_vline(aes(xintercept=upper[2]),color="red")
gg3 = ggplot(data=adolphipdfs$tie3,aes(x=x,y=y))+geom_line()+theme_bw()+xlab("GICC05 age (yb2k)")+
  ggtitle("Tie-point 3") + ylab("Density") + 
  geom_vline(aes(xintercept=x.ref[3]),color="black")+
  geom_vline(aes(xintercept=means[3]),color="blue")+
  geom_vline(aes(xintercept=lower[3]),color="red")+
  geom_vline(aes(xintercept=upper[3]),color="red")
gg4 = ggplot(data=adolphipdfs$tie4,aes(x=x,y=y))+geom_line()+theme_bw()+xlab("GICC05 age (yb2k)")+
  ggtitle("Tie-point 4") + ylab("Density") + 
  geom_vline(aes(xintercept=x.ref[4]),color="black")+
  geom_vline(aes(xintercept=means[4]),color="blue")+
  geom_vline(aes(xintercept=lower[4]),color="red")+
  geom_vline(aes(xintercept=upper[4]),color="red")
gg5 = ggplot(data=adolphipdfs$tie5,aes(x=x,y=y))+geom_line()+theme_bw()+xlab("GICC05 age (yb2k)")+
  ggtitle("Tie-point 5") + ylab("Density") + 
  geom_vline(aes(xintercept=x.ref[5]),color="black")+
  geom_vline(aes(xintercept=means[5]),color="blue")+
  geom_vline(aes(xintercept=lower[5]),color="red")+
  geom_vline(aes(xintercept=upper[5]),color="red")

library(ggpubr)
ggarrange(ggarrange(gg1,gg2,gg3,nrow=1),
          ggarrange(gg4,gg5,nrow=1),
          nrow=2)
# ggsave("adolphipdfs-4800x2000.eps", device=cairo_ps,width=4800,height=2400,units="px",dpi=500,limitsize=FALSE)
  
```

The model can be fitted using the \texttt{bremla} function, which estimates the posterior marginal distributions of the hyperparameters and also performs simulations of chronologies.


```{r hyperpars, eval=FALSE}
nsims=10000
results = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=FALSE) ,
                print.progress=TRUE
                )
{
  
  par(mfrow=c(1,2))
  plot(results$fitting$inla$hyperparameters$posteriors$sigma_epsilon,type="l",xlab=expression(paste(sigma[epsilon])),ylab="Density")
  
  abline(v=results$fitting$inla$hyperparameters$results$sigma_epsilon$mean)
  abline(v=c(results$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.025,
             results$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.975),
             col="red")
         
  plot(results$fitting$inla$hyperparameters$posteriors$phi,type="l",xlab=expression(phi),ylab="Density")
  abline(v=results$fitting$inla$hyperparameters$results$phi$mean)
  abline(v=c(results$fitting$inla$hyperparameters$results$phi$quant0.025,
             results$fitting$inla$hyperparameters$results$phi$quant0.975),
             col="red")
 par(mfrow=c(1,1)) 
}


ggp = ggplot() + theme_bw() + xlim(rev(range(results$data$age)))+
  xlab("GICC05 (yb2k)")+ylab(expression(paste(delta^18,"O (permil)")))
nevents=results$.args$events$nevents
agestarts = numeric(nevents)
for(i in 1:nevents){
  indexes = which(results$data[[paste0("psi0_",i)]]>0)
  age_i = results$data$age[indexes]
  agestarts[i]=age_i[1]
  proxy_i = results$data$proxy[indexes]
  if(i %% 2 ==0 ){
    color="red"
  }else{
    color="blue"
  }
  ggp = ggp + geom_line(data=data.frame(age_i=age_i,proxy_i=proxy_i),
                        mapping=aes(x=age_i,y=proxy_i),col=color)
}
agestarts[nevents]=last(results$data$age)
ggp = ggp + geom_vline(xintercept = agestarts,col="black",size=0.15)
print(ggp)
# ggsave("proxyplot-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)

```

The fitted model to the layer increments and the simulated chronologies (as compared to the GICC05 time scale) can be plotted as follows.

```{r unconstrained}
{
  library(ggplot2)
  
  dsims = colDiffs(rbind(matrix(rep(results$initial$age,ncol(results$simulation$age)),nrow=1),results$simulation$age))
  dmeans = rowMeans(dsims)
  dsd = rowSds(dsims)
ggd = data.frame(y = results$data$dy,depth=results$data$depth,
                   mean=dmeans,
                   lower = dmeans-1.96*dsd,
                   upper = dmeans+1.96*dsd)
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+ #xlim(rev(range(results$data$depth)))+
    geom_line(aes(y=y),col="gray")+
    geom_line(aes(y=mean),col="blue",size=0.3)+
    geom_ribbon(aes(ymin=lower,ymax=upper),color="red",alpha=0,size=0.05)+
    xlab("Depth (m)")+ylab("Layers per 5cm")
 print(ggp) 
 
 #ggsave("fitdiff-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
{
  gicc05=results$original.chron$age[1+1:n]
  ggd = data.frame(depth=results$data$depth,
                   mean=results$simulation$summary$mean-gicc05,
                   lower=results$simulation$summary$lower-gicc05,
                   upper=results$simulation$summary$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)")
  print(ggp)
  
  #ggsave("unsync-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```


## Fixed tie-points


In the paper we demonstrate our model first using the Adolphi tie-points fixed to be equal to the mode of the probability distribution. We omit the first tie-point since it falls outside of our considered interval. The constrained chronologies can be computed as follows.

```{r fixed, eval=TRUE}
fixedsims = cbind(#rep(inla.mmarginal(adolphipdfs$tie1),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie2),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie3),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie4),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie5),nsims)
                  )
synchronization = list(samples = fixedsims,nsims=nsims,
                       locations=c(#1492.50,
                                   1502.80,1532.70,1767.25,2132.40),
                       locations_unit="depth")
results_fixed = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=synchronization,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=TRUE) ,
                print.progress=TRUE
                )
{
  gicc05=results_fixed$original.chron$age[1+1:n]
  ggd = data.frame(depth=results_fixed$data$depth,
                   mean=results_fixed$simulation$summary_sync$mean-gicc05,
                   lower=results_fixed$simulation$summary_sync$lower-gicc05,
                   upper=results_fixed$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)")
  print(ggp)
  
  #ggsave("fixed-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```

Synchronizing our chronologies with the Adolphi tie-points where the uncertainties is incorporated cam be done using Monte Carlo simulations. All of this can be done using the bremla function.

```{r sync, eval = TRUE}
library(ggplot2)
library(INLA)
synchronization = list(method="adolphi",nsims=nsims,
                       locations=c(#1492.50,
                                   1502.80,1532.70,1767.25,2132.40),
                       locations_unit="depth")
results_sync = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=synchronization,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=2,summary=list(CI.type="hpd")) ,
                print.progress=TRUE
                )
tiepointranges = as.data.frame(matrix(NA,nrow=4,ncol=3))
gicc05=results_sync$original.chron$age[1+1:n]
gicc05tie = gicc05[results_sync$tie_points$locations_indexes]
colnames(tiepointranges)=c("lower","upper","depth")
for(i in 1:4){
  tiepointranges[i,1:2] = inla.hpdmarginal(0.95,adolphipdfs[[paste0("tie",i+1)]])-gicc05tie[i]
}
tiepointranges[,3] = depth[results_sync$tie_points$locations_indexes]
{
  
  ggd = data.frame(depth=results_sync$data$depth,
                   mean=results_sync$simulation$summary_sync$mean-gicc05,
                   lower=results_sync$simulation$summary_sync$lower-gicc05,
                   upper=results_sync$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    geom_linerange(data=tiepointranges,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp)
  
  #ggsave("sync-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```


# Applications




## Abrupt warmings

The onset of abrupt warmings is dated in two stages that are combined to express the complete dating uncertainty, pertaining to the uncertainty originating from both the age-depth relationship as well as estimating the depth in the record which represent the onset of the transition. The latter is estimated using a linear ramp model as described in Erhardt et al. (2019). The linear ramp fit can be performed and plotted as follows.



```{r events_individual, eval=FALSE}
eventnumber=13 #number between 1 and 29. specifies which transition to consider
#load data window and specifics to transition
lowerints = which.index(event_intervals$depth_int_lower.m, depth[2:length(depth)])
upperints = which.index(event_intervals$depth_int_upper.m, depth[2:length(depth)])
depth.reference = event_intervals$NGRIP_depth_m[eventnumber]
age.reference = event_intervals$GICC_age.yb2k[eventnumber]
interval = lowerints[eventnumber]:upperints[eventnumber]
transitionlabel = str_sub(event_intervals$onsetlabel[eventnumber],
                      str_locate(event_intervals$onsetlabel[eventnumber],"GI")[1])
control.linramp=list(proxy=proxy,
                     interval=interval,
                     interval.unit="index",
                     depth.reference=event_intervals$NGRIP_depth_m[eventnumber]
                     )
results_event = linrampfitter(results_sync,control.linramp)
control.transition_dating = list(label="Simulated transition")
results_event = events_depth_to_age(results_event,
                                    control.transition_dating=control.transition_dating)
{
  ggd1 = data.frame(depth=depth[interval],proxy=proxy[interval],
                    x=results_event$linramp$data$x,
                    mean=results_event$linramp$linrampfit$mean,
                    lower=results_event$linramp$linrampfit$q0.025,
                    upper=results_event$linramp$linrampfit$q0.975
                    )
  gg1 = ggplot(data=ggd1,aes(x=depth))+geom_line(aes(y=proxy),col="gray")+
    theme_bw()+ xlim(rev(range(depth[interval])))+xlab("Depth (m)")+
    ylab(expression(paste(delta^18,"O (permil)")))+ggtitle("(a) GI-11 Linear ramp fit")+
    geom_ribbon(aes(x=x,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(x=x,y=mean),col="blue",size=0.7)
    
  ybottom = min(results_event$linramp$data$y)
  ytop = min(results_event$linramp$linrampfit$q0.025)
  margt0=results_event$linramp$param$t0$marg.t0
  normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt0[,1],y=normt0.y),aes(x=x,y=y),col="blue")
  
  margt1 = results_event$linramp$param$t1$marginal
  normt1.y = margt1[,2]/diff(range(margt1[,2]))*(ytop-ybottom)-min(margt1[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt1[,1],y=normt1.y),aes(x=x,y=y),col="blue",
                        linetype="dashed")
  
  gg1 = gg1 + geom_vline(aes(xintercept=depth.reference),linetype="dotted",size=0.8)
  
  gd2 = as.data.frame(results_event$linramp$param$t0$marg.t0)
  gg2 = ggplot(data=gd2,mapping=aes(x=x,y=y)) + geom_line()+theme_bw()+
    xlab("Onset depth (m)") + ylab("Density") + ggtitle("(b) Marginal posterior of onset depth")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$mean),col="blue")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$q0.025),col="red")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$q0.975),col="red")
  
  
  gd3 = as.data.frame(results_event$linramp$param$t1$marginal)
  gg3 = ggplot(data=gd3,mapping=aes(x=x,y=y)) + geom_line()+theme_bw()+
    xlab("Onset depth (m)") + ylab("Density") + ggtitle("(c) Marginal posterior of end-point depth")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$mean),col="blue")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$q0.025),col="red")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$q0.975),col="red")
  
  
  ggarrange(gg1,ggarrange(gg2,gg3,nrow=1),nrow=2)
  #ggsave("GI-11-rampfit-4800x3000.eps", device=cairo_ps,width=4800,height=3000,units="px",dpi=500,limitsize=FALSE)
  
  gghist = ggplot(data = data.frame(ages=results_event$event_dating$samples)) + theme_bw()+
    geom_histogram(aes(x=ages,y=..density..),fill="orange",col="black")+xlab("Onset age (yb2k)")+
    ylab("Density") + ggtitle("GI-11 Onset age") +
    geom_vline(aes(xintercept = age.reference),lty=3,size=0.8)+
    geom_vline(aes(xintercept=results_event$event_dating$mean),col="blue",size=0.7)+
    geom_vline(aes(xintercept=results_event$event_dating$q0.025),col="red",size=0.7)+
    geom_vline(aes(xintercept=results_event$event_dating$q0.975),col="red",size=0.7)+
    xlim(rev(range(results_event$event_dating$samples)))
  
  #ggsave("GI-11-histogram-4800x3000.eps", device=cairo_ps,width=4800,height=3000,units="px",dpi=500,limitsize=FALSE)
  
}
```


We want to compare the dating onsets with those given by Rasmussen et al. (2014), Capron (2021) and Buizert et al. (2015). We start by importing those values

```{r events_import, eval=FALSE}
##### IMPORT MYRVOLL-NILSEN 2022 DATA AND COMPARE POSTERIORS ####
library(readxl)
rasmussen_depths = event_intervals$NGRIP_depth_m
rasmussen_ages = event_intervals$GICC_age.yb2k #GISevents$`Age (a b2k)`
buizert_onsets = read_excel("data/Buizert_onsets.xlsx",
                            col_types=c("text","numeric","numeric","numeric","numeric"))
buizert_depths = buizert_onsets$Depth; buizert_ages = buizert_onsets$Age
#buizert_depths[c(2:6,8:9,12:13,15:17,19:21)]
buizert_ages = buizert_ages[c(2:6,8:9,12:13,15:17,19:21)]
capron_onsets_NGRIP_d18O = read_excel("data/Capron_onsets.xls",
                           sheet="d18O",n_max=25)
capron_ages_NGRIP_d18O = capron_onsets_NGRIP_d18O$`t1 (50%)`
capind = numeric(29); buiind = numeric(29)
capind = c(NA,2,3, 4,5,6,NA,NA,7,8,NA,9,10,11,NA,NA,NA,NA,NA,12,13,14,NA,NA,15,NA,NA,16,17)
buiind = c(NA,2,NA,3,4,6,NA,NA,8,9,NA,11,12,13,NA,NA,NA,NA,NA,15,16,17,NA,NA,19,NA,NA,20,21)
```

We then estimate the dating uncertainty for all 29 events
```{r compare_transitions_1}
agesimmatrix_d18O = matrix(NA,29,nsims)
agesimmatrix_d18O_unsync = matrix(NA,29,nsims)
depthlist_d18O = c()
do.plot.rampfit = TRUE
do.plot.agehist = FALSE
depthstats = as.data.frame(matrix(NA,4,29))
colnames(depthstats) = c("true", "mean", "CIL","CIU","dustmean","dustCIL","dustCIU")
agestats = as.data.frame(matrix(NA,4,29))
colnames(agestats) = c("true", "mean", "CIL","CIU","dustmean","dustCIL","dustCIU")
steplengths = rep(0.01,29)
steplengths[21]=0.001 #sometimes changing the steplength slightly might improve convergence (default is 0.01)
for(eventnumber in 1:29){
  transitionlabel = str_sub(event_intervals$onsetlabel[eventnumber],
                      str_locate(event_intervals$onsetlabel[eventnumber],"GI")[1])
  lowerints = which.index(event_intervals$depth_int_lower.m, results_sync$data$depth)
  upperints = which.index(event_intervals$depth_int_upper.m, results_sync$data$depth)
  interval = lowerints[eventnumber]:upperints[eventnumber]
  
  depth.reference = event_intervals$NGRIP_depth_m[eventnumber]
  age.reference = event_intervals$GICC_age.yb2k[eventnumber]
  
  control.linramp = list(proxy=proxy,interval=interval,interval.unit="index",
                         depth.ref=depth.reference, 
                         label=paste0(eventnumber," (d18O):", event_intervals[eventnumber,2])
                         )
  
  temp_d18O = linrampfitter(results_sync,control.linramp)
  if(do.plot.rampfit){
    {plot(depth[interval],proxy[interval],type="l",col="gray",
          xlim=rev(range(depth[interval])), xlab="Depth (m)",ylab=expression(paste(delta^18,"O (permil)")),
          main=paste0(eventnumber,": ", transitionlabel))
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$mean)
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$q0.025,col="red")
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$q0.975,col="red")
      abline(v=rasmussen_depths[eventnumber],lty=3)
      
      ybottom = min(temp_d18O$linramp$data$y)
      ytop = min(temp_d18O$linramp$linrampfit$q0.025)
      margt0=temp_d18O$linramp$param$t0$marg.t0
      normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
      lines(x=margt0[,1],y=normt0.y,col="blue",lwd=2)
      ybottom = min(temp_d18O$linramp$data$y)
      ytop = min(temp_d18O$linramp$linrampfit$q0.025)
      margt1 = temp_d18O$linramp$param$t1$marginal
      normt1.y = margt1[,2]/diff(range(margt1[,2]))*(ytop-ybottom)-min(margt1[,2])+ybottom
      lines(x=margt1[,1],y=normt1.y,col="blue",lwd=2,lty=3)
    }
  }
  
  
  control.transition_dating=list(label="d18O")
  agetemp_d18O = events_depth_to_age(temp_d18O,control.transition_dating)
  agetemp_d18O_unsync = events_depth_to_age(temp_d18O,
                                            control.transition_dating=list(label="d18O",
                                                                           sync=FALSE))
  
  
  agesimmatrix_d18O[eventnumber,] = agetemp_d18O$event_dating$samples 
  agesimmatrix_d18O_unsync[eventnumber,] = agetemp_d18O_unsync$event_dating$samples 
  if(do.plot.agehist){
    hist(agesimmatrix_d18O[eventnumber,],freq=0,breaks=50,col="orange",main=paste0("Onset age: ",transitionlabel),xlab="Age (yb2k)")
    abline(v=age.reference,col="blue")
  }
  
  #Store summary statistics
  depthstats[1,eventnumber] = event_intervals$NGRIP_depth_m[eventnumber]
  depthstats[2,eventnumber] = agetemp_d18O$linramp$param$t0$mean
  depthstats[3,eventnumber] = agetemp_d18O$linramp$param$t0$q0.025
  depthstats[4,eventnumber] = agetemp_d18O$linramp$param$t0$q0.975
  
  densage = density(agesimmatrix_d18O[eventnumber,]); densage = data.frame(x=densage$x,y=densage$y)
  
  zage = inla.zmarginal(densage,silent=TRUE)
  
  agestats[1,eventnumber] = event_intervals$GICC_age.yb2k[eventnumber]
  agestats[2,eventnumber] = mean(agesimmatrix_d18O[eventnumber])
  agestats[3,eventnumber] = zage$quant0.025
  agestats[4,eventnumber] = zage$quant0.975
  
}
```


```{r compare_transitions_2}

  # library(cowplot)
  
  ggplots = c()

  for(i in 1:29){
    dens = density(agesimmatrix_d18O[i,])
    dens = data.frame(x=dens$x,y=dens$y)#/max(dens2$y))
    densunsync = density(agesimmatrix_d18O_unsync[i,])
    densunsync = data.frame(x=densunsync$x,y=densunsync$y)#/max(dens2$y))
    xlim = rev(range(dens$x,densunsync$x))
    
    ggd = data.frame(x=dens$x,y=dens$y,x0=densunsync$x,y0=densunsync$y)
    ggdrasmus = data.frame(rasmus=event_intervals$GICC_age.yb2k[i])
    title = str_sub(event_intervals[i,2],str_locate(event_intervals[i,2],"GI-")[1])
    
    gg = ggplot(data=ggd) + theme_bw()+xlim(xlim)+
      geom_line(aes(x=x0,y=y0),col="gray",size=0.7)+
      geom_line(aes(x=x,y=y),col="black",size=0.7)+
      xlab("Onset year (yb2k)")+ylab("Density") +
      ggtitle(title)+
      theme(axis.text.y=element_blank(),
            axis.ticks.y=element_blank())+
      # geom_vline(aes(xintercept = event_intervals$GICC_age.yb2k[i]),col="blue",size=0.7)
      geom_vline(data=ggdrasmus, aes(xintercept = rasmus),col="blue",size=0.7)
    
      
      

  if(!is.na(buiind[i])){
    ggdbuizert = data.frame(buizert=buizert_onsets$Age[buiind[i]])
    gg = gg + geom_vline(data=ggdbuizert,aes(xintercept = buizert),col="green",size=0.7)
    #abline(v=buizert_onsets$Age[buiind[i]],col="green")
    #abline(v=buizert_ages[buiind[i]],col="green")
  }

  if(!is.na(capind[i])){
    ggdcapron = data.frame(capron=capron_ages_NGRIP_d18O[capind[i]])
    gg = gg + geom_vline(data=ggdcapron,aes(xintercept = capron),col="red",size=0.7)
    # abline(v=capron_ages_NGRIP_d18O[capind[i]],col="red")
  }
    # ggplots = c(ggplots,list(gg))
    ggplots[[i]] = gg
  }
  
  ggl=ggplot(data.frame(x = 1,x0=1, y = 1,y0=1, rasmus=1,buizert=1,capron=1))+
    geom_line(aes(x=x,y=y,col="Synchronized onset posterior"),size=1)+
    geom_line(aes(x=x0,y=y0,col="Unsynchronized onset posterior"))+
    geom_line(aes(x=x,y=rasmus,col="Rasmussen onset"))+
    geom_line(aes(x=x,y=buizert,col="Buizert onset"))+
    geom_line(aes(x=x,y=capron,col="Capron onset"))+
                        # colour = 'Something2'), aes(x, y, fill = colour))+
  # geom_point(alpha=0, shape = 0)+ # completely transparent rectangular point 
  # scale_fill_manual(values='black', drop=FALSE) +
   # guides(color = guide_legend(override.aes = list(alpha=1, size = 1.3)))+ # showing the point in the legend
    scale_color_manual(values=c("Synchronized onset posterior"="black",
                                "Unsynchronized onset posterior"="gray",
                                "Rasmussen onset"="blue",
                                "Buizert onset"="green",
                                "Capron onset"="red"),
                       labels=c("Synchronized onset posterior",
                                "Unsynchronized onset posterior",
                                "Rasmussen onset",
                                "Buizert onset",
                                "Capron onset"))+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        # legend.text = element_text(size = 17),
        legend.key = element_rect(fill='NA'),
        # legend.key.size = unit(0.8,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(0.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )
  ggplots[[30]] = ggl
  ggarrange(plotlist=ggplots,widths=c(6,5))
  
  # ggsave("allevents-4800x3000.eps",device=cairo_ps,width=4800,height=3000,units="px",limitsize=FALSE)
    

rownames=c()
for(i in 1:29){
  rownames=c(rownames,str_sub(event_intervals[i,2],str_locate(event_intervals[i,2],"GI-")[1]))
}
#colnames = colnames(depthstats)[1:4]
#colnames = c("name","d18O_mean","d18O_q0.025","d18O_q0.975")
depthresults = t(depthstats)[,2:4]
colnames(depthresults)=c("Z* mean", "Z* q0.025","Z* q0.975")
ageresults = t(agestats[2:4,])
colnames(ageresults)=c("Y* mean", "Y* q0.025","Y* q0.975")
allresults = cbind(depthresults,ageresults)
rownames(allresults)=rownames
latexstr = "Event & Z^* mean (m) & Z^* 95\\% CI (m) & Y^* mean (yb2k) & Y^* 95\\% CI (yb2k) \\\\ \n"
for(i in 1:29){
  latexstr = paste0(latexstr,rownames[i], "& ", format(round(allresults[i,1],2),nsmall=2)," & (", format(round(allresults[i,2],2),nsmall=2), ",
         ",format(round(allresults[i,3],2),nsmall=2),") & ", format(round(allresults[i,4],2),nsmall=2)," & (",format(round(allresults[i,5],2),nsmall=2),", ",format(round(allresults[i,6],2),nsmall=2),") \\\\ \n"
         )
}
cat(latexstr)
```



# Other stuff




To get started, see the documentation '?bremla' and the associated example.

The package includes the NGRIP/GICC05 data set 'NGRIP_d18O_and_dust_5cm' downloaded from [Centre for Ice and Climate](iceandclimate.nbi.ku.dk) at the Niels Bohr Institute of the University of Copenhagen, Denmark, and the table of stadial-interstadial events presented by [Rasmussen et al. (2014)](https://www.sciencedirect.com/science/article/pii/S0277379114003485). Also includes the tie-point presented in [Adolphi et al. (2018)](https://cp.copernicus.org/articles/14/1755/2018/) and [Muscheler et al. (2020)](https://www.cambridge.org/core/journals/radiocarbon/article/testing-and-improving-the-intcal20-calibration-curve-with-independent-records/D72D9214C47FE9441B5E730D33DCCE3D). Other data and tie-points should work as well.

Warning: The provided real data example generates several thousand simulated chronologies with individual lengths exceeding 18,000. More if synchronized chronologies is also computed. This will require a significant amount of memory. If needed, reduce the number of samples generated or free up memory before use.

## Illustration example

The data used to generate the illustrative examples in the paper is as follows.

```{r illustrationexample}
rm(list=ls())
require(stats)
library(ggplot2)
set.seed(123)
n=800
y0 = 0
z0 = 0
phi=0.8; sigma=1.2
depth = z0+seq(from=1,to=n,length.out=n)

covariate = arima.sim(model=list(ar=c(0.99)),n=n)
noise = sigma*arima.sim(model=list(ar=c(phi)),n=n,sd=sqrt(1-phi^2))

dy = 10 + depth*5/n+covariate+noise
y = y0+cumsum(dy)

data=data.frame(age=c(y0,y),depth=c(z0,depth),dy=c(0,as.numeric(dy)),covariate=c(0,covariate))
#data=rbind(c(y0,z0,0,0),df)
formula=dy~ 1 + depth + covariate 
nsims = 10000

# Unsynchronized
res = bremla(formula,data,reference.label="simulated time scale",nsims=nsims,
             control.fit=list(noise="ar1"),
             x.label="Depth",
             y.label="Ensemble age - observed age",
             control.sim = list(synchronized=FALSE,
                                nsims=nsims))

library(ggplot2)
orichron = res$data$age
ggd = data.frame(depth=res$data$depth,
                 mean = res$simulation$summary$mean-orichron,
                 lower = res$simulation$summary$lower-orichron,
                 upper = res$simulation$summary$upper-orichron)
ggp = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)
# plot(res)
#ggsave("illustrative-unsync.eps",device=cairo_ps,width=4800,height=2000,units="px")

# Fixed tie-points
ntie = 3
tiesims = matrix(NA,nrow=nsims,ncol=ntie)
tiedepths = c(100,300,600)
tieage = c(450,3000,8500)

for(i in 1:ntie){
  tiesims[,i] = rep(tieage[i],nsims)
}

res2 = tiepointsimmer(res,synchronization = list(locations=tiedepths,locations_unit="depth",
                       samples = tiesims)
               )

res2 = bremla_synchronized_simulation(res2,control.sim=list(synchronized=TRUE))

ggd = data.frame(depth=res2$data$depth,
                 mean = res2$simulation$summary_sync$mean-orichron,
                 lower = res2$simulation$summary_sync$lower-orichron,
                 upper = res2$simulation$summary_sync$upper-orichron)

oritie = orichron[tiedepths]
ggd2 = data.frame(depth=res2$tie_points$locations,
                  mean=res2$simulation$summary_sync$mean[tiedepths]-oritie)

ggp = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_point(data=ggd2,mapping=aes(x=depth,y=mean),col="magenta",size=1)
#plot(res)
#ggsave("illustrative-fixedsync.eps",device=cairo_ps,width=4800,height=2000,units="px")

tiemeans = c(450,3000,8500)
tiesds = c(10,20,30)
res3 = tiepointsimmer(res,synchronization = list(locations=tiedepths,
                                                locations_unit="depth",
                                                method="normal",
                                                params=list(mean=tiemeans,
                                                            sd=tiesds))
               )
res3 = bremla_synchronized_simulation(res3,control.sim=list(synchronized=TRUE))
ggd = data.frame(depth=res3$data$depth,
                 mean = res3$simulation$summary_sync$mean-orichron,
                 lower = res3$simulation$summary_sync$lower-orichron,
                 upper = res3$simulation$summary_sync$upper-orichron)

oritie = orichron[tiedepths]
ggd2 = data.frame(depth=res3$tie_points$locations,
                  lower=res3$simulation$summary_sync$lower[tiedepths]-oritie,
                  upper=res3$simulation$summary_sync$upper[tiedepths]-oritie)

ggp = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_segment(data=ggd2,mapping=aes(x=depth,xend=depth,y=lower,yend=upper), 
               col="magenta",size=0.7)
  
#plot(res3)
#ggsave("illustrative-sync.eps",device=cairo_ps,width=4800,height=2000,units="px")

```

## Simulation example

To verify our model we can test it on simulated data where the true parameters are known.

```{r simex}
rm(list=ls())
require(stats)
library(ggplot2)
set.seed(123)
n=1000
y0 = 1000
z0 = 1200
phi=0.8; sigma=1.2
depth = z0+seq(from=0.5,500,length.out=1000)
dnoise = sigma*arima.sim(n=n,model=list(ar=c(phi)),sd=sqrt(1-phi^2))
proxy = arima.sim(n=n,model=list(ar=0.9),sd=sqrt(1-0.9^2))
events=list(locations=c(1,250,750,1000))
a1 = c(-rep(1,249)*15,numeric(751))
a2 = c(numeric(249),rep(1,500)*50,numeric(251))
a3 = c(numeric(749),-rep(1,251)*110)
c1 = c(depth[1:249]/60,numeric(751))
c2 = c(numeric(249),-depth[1:500]/40,numeric(251))
c3 = c(numeric(749),depth[1:251]/10)
dy = dnoise + a1+a2+a3+c1+c2+c3 + proxy*0.5
age = y0+cumsum(dy)
df=data.frame(age=age,dy=as.numeric(dy),proxy=as.numeric(proxy),depth=depth,depth2=depth^2); data=rbind(c(y0,z0,0,0,0),df)
formula=dy~-1+proxy#+depth2
nsims = 10000
synchronization = list(locations = c(200,400,800),locations_unit="index",method="gauss", nsims=nsims,params=list(mean=c(2200,5600,11500),sd=c(10,50,60)))
res = bremla(formula,data,reference.label="simulated time scale",nsims=nsims,
             events=list(locations=c(1,250,750,1000),locations_unit="index"),
             control.fit=list(noise="ar1"),
             synchronization=synchronization,
             control.sim = list(synchronized=TRUE,
                                nsims=nsims))
par(mfrow=c(1,2))
plot(res$fitting$inla$hyperparameters$posteriors$sigma_epsilon,type="l",xlab=expression(sigma),ylab="Density",main=expression(paste("(a) Posterior distribution of ",sigma)))
abline(v=res$fitting$inla$hyperparameters$results$sigma_epsilon$mean,lwd=1.5)
abline(v=c(res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.025,
           res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.975),lwd=1.5,col="red")
plot(res$fitting$inla$hyperparameters$posteriors$phi,type="l",xlab=expression(phi),ylab="Density",main=expression(paste("(b) Posterior distribution of ",phi)))
abline(v=res$fitting$inla$hyperparameters$results$phi$mean,lwd=1.5)
abline(v=c(res$fitting$inla$hyperparameters$results$phi$quant0.025,
           res$fitting$inla$hyperparameters$results$phi$quant0.975),lwd=1.5,col="red")
par(mfrow=c(1,1))
#plot results
  
  dsims = colDiffs(rbind(matrix(rep(res$initial$age,ncol(res$simulation$age)),nrow=1), res$simulation$age))
  dmeans = rowMeans(dsims)
  dsd = rowSds(dsims)
ggd = data.frame(y = res$data$dy,depth=res$data$depth,
                   mean=dmeans,
                   lower = dmeans-1.96*dsd,
                   upper = dmeans+1.96*dsd)
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+ #xlim(rev(range(results$data$depth)))+
    geom_line(aes(y=y),col="gray")+
    geom_line(aes(y=mean),col="blue",size=0.8)+
    geom_ribbon(aes(ymin=lower,ymax=upper),color="red",alpha=0,size=0.8)+
    xlab("Depth (m)")+ylab("Layers per 5cm")+ggtitle("(a) Fitted layer increment model")
  
  
  ggd2 = data.frame(mean=res$simulation$summary_sync$mean-res$data$age,
                    lower=res$simulation$summary_sync$lower-res$data$age,
                    upper=res$simulation$summary_sync$upper-res$data$age,
                    depth=res$data$depth
                    )
  
 reference=res$original.chron$age[1+1:n]
 reftie = reference[res$tie_points$locations_indexes]
ggdtie = data.frame(mean=synchronization$params$mean-reftie,
                    upper=synchronization$params$mean+1.96*synchronization$params$sd-reftie,
                    lower=synchronization$params$mean-1.96*synchronization$params$sd-reftie,
                    locations = res$data$depth[synchronization$locations])
ggp2 = ggplot(data=ggd2,aes(x=depth)) + theme_bw()+
  geom_ribbon(aes(ymin=lower,ymax=upper),color="red",fill="red",alpha=0.3)+
  geom_line(aes(y=mean),color="blue") +
  geom_linerange(data=ggdtie,aes(x=locations,ymin=lower,ymax=upper),color="magenta")+
  xlab("Depth (m)") + ylab("Deviation from simulated reference (years)")+
  ggtitle("(b) Simulated chronologies")
library(gridExtra)
ggsave("fitdiffsim-5500x4000.eps", device=cairo_ps,width=5500,height=4000,units="px",dpi=500,limitsize=FALSE,arrangeGrob(ggp,ggp2))
str = ""
for(i in 1:length(res$fitting$inla$fit$summary.fixed$mean)){
  str=paste0(str," & & ",format(res$fitting$inla$fit$summary.fixed$mean[i],digits=7,scientific=FALSE), " & (",
             format(res$fitting$inla$fit$summary.fixed$`0.025quant`[i],digits=7,scientific=FALSE),", ",
             format(res$fitting$inla$fit$summary.fixed$`0.975quant`[i],digits=7,scientific=FALSE),") \\\\ \n")
}
cat(str)  
```

## Real data example
This is a real data example which produces 5000 simulations from a synchronized time scale.
```{r example, message=FALSE, warning=FALSE, include=TRUE}
require(INLA)
library(bremla)
data("event_intervals")
data("events_rasmussen")
data("NGRIP_5cm")
age = NGRIP_5cm$age
depth = NGRIP_5cm$depth
proxy = NGRIP_5cm$d18O
data = data.frame(age=age,dy=c(NA,diff(age)),depth=depth,depth2=depth^2,proxy=proxy)
formula = dy~-1+depth2
events=list(locations = events_rasmussen$depth,
            locations_unit="depth",degree=1)
results = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=list(method="adolphi"),
                control.fit=list(method="inla"),
                control.sim=list(synchronized=TRUE) )
summary(results)
```

```{r plot, message=FALSE, eval=TRUE, echo=FALSE}
require(ggplot2)
free_indexes = results$tie_points$free_indexes
tie_indexes = results$tie_points$tie_indexes
ageref_free = results$data$age[free_indexes]
ageref_tie = results$data$age[tie_indexes]
fullpd = data.frame(depth = results$data$depth[free_indexes],
                medians=results$simulation$summary_sync$median[free_indexes]-ageref_free,
                lower=results$simulation$summary_sync$lower[free_indexes]-ageref_free,
                upper=results$simulation$summary_sync$upper[free_indexes]-ageref_free)
gg2 = ggplot(data=fullpd,aes(x=depth)) +
geom_line(aes(y=rep(0,nrow(fullpd))),color="blue",linetype="dotted",size=0.2)+
theme_bw()+ylab("Estimated age - reference (years)")+
xlab("NGRIP depth (m)")
gg2 = gg2+geom_line(aes(y=medians))+
geom_ribbon(aes(ymin=.data$lower,ymax=.data$upper),color="red",fill="red",alpha=0.3)
gg2 = gg2 + geom_segment(data=data.frame(depth=results$data$depth[tie_indexes],                                   median=results$simulation$summary_sync$median[tie_indexes]-ageref_tie,                         lower=results$simulation$summary_sync$lower[tie_indexes]-ageref_tie,
                   upper=results$simulation$summary_sync$upper[tie_indexes]-ageref_tie),
                   aes(x=.data$depth,y=.data$lower,xend=.data$depth,yend=.data$upper),
                   col="magenta")
print(gg2)
```   

## Attribution

This code is associated and written for the papers Myrvoll-Nilsen et al. (2022) and Myrvoll-Nilsen et al. (202x) mentioned above. Feel free to use the code, but please cite the accompanying papers.

## License

The code in this repository is made available under the terms of the GNU (version >=2) License. For details, see LICENSE.md file.
