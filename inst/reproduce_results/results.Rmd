---
output: github_document
---

<!-- results.md is generated from results.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/reproduce/results/results-",
  dev = "png",
  out.width = "100%"
)
```

# bremla

This file includes the data and code needed to reproduce the results for

Myrvoll-Nilsen, E., Riechers, K. & Boers, N. (202x). Tie-point paper (title TBD)

# Myrvoll-Nilsen et al. (202x)

The data used is the NGRIP/GICC05 data set 'NGRIP_d18O_and_dust_5cm', downloaded from [Centre for Ice and Climate](iceandclimate.nbi.ku.dk) at the Niels Bohr Institute of the University of Copenhagen, Denmark, and the table of stadial-interstadial events presented by [Rasmussen et al. (2014)](https://www.sciencedirect.com/science/article/pii/S0277379114003485). These are included in the package and can be imported as follows. 
```{r initialize, eval=FALSE}
#library(bremla)
data("event_intervals")
data("events_rasmussen")
data("NGRIP_5cm")
age = NGRIP_5cm$age
depth = NGRIP_5cm$depth
depth2 = depth^2/depth[1]^2 #normalize for stability
proxy = NGRIP_5cm$d18O
n=length(diff(age))
data = data.frame(age=age,dy=c(NA,diff(age)),depth=depth,depth2=depth2,proxy=proxy)
events=list(locations = events_rasmussen$depth,
            locations_unit="depth",degree=1)
# plot(depth,proxy,xlab="Age (yb2k)",ylab=expression(paste(d^18,"O (permil)")),type="l",
     # xlim=rev(range(depth)))+abline(v=events$locations,col="gray",lwd=0.7)
formula = dy~-1+depth2+proxy
```


We also use tie-points described by probability distributions obtained from Adolphi et al. (2018) and Muscheler et al. (2020). These can be imported as follows.

```{r adolphi, eval=TRUE}
library(ggplot2)
x.ref=c(11050,12050,13050,22050,42050)
adolphipdfs = adolphiloader(tieshifts=c(11050,12050,13050,22050,42050),
                            plotdens = FALSE,
                            x.ref=x.ref)
lower = c(-77.53, -30.92, -12.37, 336.19, 101.51)#+x.ref
upper = c(-41.09, 11.94, 21.99, 714.03, 509.08)#+x.ref
means = c(-59.95, -7.04, 3.34, 521.44, 275.24)#+x.ref
medians = c(-60.10, -6.42, 2.64, 532.36, 243.57)#+x.ref
adolphipdfs_offsets = c()
for(i in 1:5){
  adolphipdfs_offsets[[i]] = cbind(as.numeric(adolphipdfs[[i]]$x)-x.ref[i],
                                   as.numeric(adolphipdfs[[i]]$y))
  colnames(adolphipdfs_offsets[[i]]) = c("x","y")
  #adolphipdfs_offsets[[i]]$x = adolphipdfs[[i]]$x-x.ref
}

gg1 = ggplot(data=as.data.frame(adolphipdfs_offsets[[1]]),aes(x=x,y=y))+geom_line()+theme_bw()+xlab("Age offset (years)")+
  ggtitle("Tie-point 1") + ylab("Density") + 
  xlim(c(-100,100))+
  #geom_vline(aes(xintercept=x.ref[1]),color="black")+
  geom_vline(aes(xintercept=means[1]),color="blue")+
  geom_vline(aes(xintercept=lower[1]),color="red")+
  geom_vline(aes(xintercept=upper[1]),color="red")
gg2 = ggplot(data=as.data.frame(adolphipdfs_offsets[[2]]),aes(x=x,y=y))+geom_line()+theme_bw()+xlab("Age offset (years)")+
  ggtitle("Tie-point 2") + ylab("Density") + 
    xlim(c(-60,60))+
  #geom_vline(aes(xintercept=x.ref[2]),color="black")+
  geom_vline(aes(xintercept=means[2]),color="blue")+
  geom_vline(aes(xintercept=lower[2]),color="red")+
  geom_vline(aes(xintercept=upper[2]),color="red")
gg3 = ggplot(data=as.data.frame(adolphipdfs_offsets[[3]]),aes(x=x,y=y))+geom_line()+theme_bw()+xlab("Age offset (years)")+
  ggtitle("Tie-point 3") + ylab("Density") + 
    xlim(c(-60,60))+
  #geom_vline(aes(xintercept=x.ref[3]),color="black")+
  geom_vline(aes(xintercept=means[3]),color="blue")+
  geom_vline(aes(xintercept=lower[3]),color="red")+
  geom_vline(aes(xintercept=upper[3]),color="red")
gg4 = ggplot(data=as.data.frame(adolphipdfs_offsets[[4]]),aes(x=x,y=y))+geom_line()+theme_bw()+xlab("Age offset (years)")+
  ggtitle("Tie-point 4") + ylab("Density") + 
    xlim(c(-0,1000))+
  #geom_vline(aes(xintercept=x.ref[4]),color="black")+
  geom_vline(aes(xintercept=means[4]),color="blue")+
  geom_vline(aes(xintercept=lower[4]),color="red")+
  geom_vline(aes(xintercept=upper[4]),color="red")
gg5 = ggplot(data=as.data.frame(adolphipdfs_offsets[[5]]),aes(x=x,y=y))+geom_line()+theme_bw()+xlab("Age offset (years)")+
  ggtitle("Tie-point 5") + ylab("Density") + 
    xlim(c(-250,750))+
  #geom_vline(aes(xintercept=x.ref[5]),color="black")+
  geom_vline(aes(xintercept=means[5]),color="blue")+
  geom_vline(aes(xintercept=lower[5]),color="red")+
  geom_vline(aes(xintercept=upper[5]),color="red")

library(ggpubr)
ggarrange(ggarrange(gg2,gg3,nrow=1),
          ggarrange(gg4,gg5,nrow=1),
          nrow=2)
 # ggsave("adolphipdfs-no1-4800x2000.eps", device=cairo_ps,width=4800,height=2400,units="px",dpi=500,limitsize=FALSE)
  
```

The model can be fitted using the \texttt{bremla} function, which estimates the posterior marginal distributions of the hyperparameters and also performs simulations of chronologies.


```{r hyperpars, eval=FALSE}
nsims=10000
results = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=FALSE) ,
                print.progress=TRUE
                )
{
  
  par(mfrow=c(1,2))
  plot(results$fitting$inla$hyperparameters$posteriors$sigma_epsilon,type="l",xlab=expression(paste(sigma[epsilon])),ylab="Density")
  
  abline(v=results$fitting$inla$hyperparameters$results$sigma_epsilon$mean)
  abline(v=c(results$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.025,
             results$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.975),
             col="red")
         
  plot(results$fitting$inla$hyperparameters$posteriors$phi,type="l",xlab=expression(phi),ylab="Density")
  abline(v=results$fitting$inla$hyperparameters$results$phi$mean)
  abline(v=c(results$fitting$inla$hyperparameters$results$phi$quant0.025,
             results$fitting$inla$hyperparameters$results$phi$quant0.975),
             col="red")
 par(mfrow=c(1,1)) 
}


ggp = ggplot() + theme_bw() + xlim(rev(range(results$data$age)))+
  xlab("GICC05 (yb2k)")+ylab(expression(paste(delta^18,"O (permil)")))
nevents=results$.args$events$nevents
agestarts = numeric(nevents)
for(i in 1:nevents){
  indexes = which(results$data[[paste0("psi0_",i)]]>0)
  age_i = results$data$age[indexes]
  agestarts[i]=age_i[1]
  proxy_i = results$data$proxy[indexes]
  if(i %% 2 ==0 ){
    color="red"
  }else{
    color="blue"
  }
  ggp = ggp + geom_line(data=data.frame(age_i=age_i,proxy_i=proxy_i),
                        mapping=aes(x=age_i,y=proxy_i),col=color)
}
library(dplyr)
agestarts[nevents]=last(results$data$age)
ggp = ggp + geom_vline(xintercept = agestarts,col="black",size=0.15)
print(ggp)
# ggsave("proxyplot-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)

ggd = data.frame(age=data$age,depth=data$depth,proxy=data$proxy)
ggdr = data.frame(depths=events_rasmussen$depth[events_rasmussen$depth>1492.45 & events_rasmussen$depth<2426],ages=events_rasmussen$age[events_rasmussen$age>11703.07 & events_rasmussen$age < 59944.50])
library(ggplot2)
ggp2 = ggplot(data=ggd) + theme_bw()+
  geom_line(aes(x=age,y=proxy),col="black",size=0.5)+
  geom_vline(data=ggdr,mapping=aes(xintercept=ages),col="gray",size=0.5)+
  xlab("GICC05 age (yb2k)") + ylab(expression(paste(delta^18,"O (permil)")))
  
# ggsave("proxyplot-bw-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)

# ggplot(data=ggd)+geom_line(aes(x=depth,y=age))

```

The fitted model to the layer increments and the simulated chronologies (as compared to the GICC05 time scale) can be plotted as follows.

```{r unconstrained}
{
  library(matrixStats)
  library(ggplot2)
  
  dsims = colDiffs(rbind(matrix(rep(results$initial$age,ncol(results$simulation$age)),nrow=1),results$simulation$age))
  dmeans = rowMeans(dsims)
  dsd = rowSds(dsims)
ggd = data.frame(y = results$data$dy,depth=results$data$depth,
                   mean=dmeans,
                   lower = dmeans-1.96*dsd,
                   upper = dmeans+1.96*dsd)
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+ #xlim(rev(range(results$data$depth)))+
    geom_line(aes(y=y),col="gray")+
    geom_line(aes(y=mean),col="blue",size=0.3)+
    geom_ribbon(aes(ymin=lower,ymax=upper),color="red",alpha=0,size=0.05)+
    xlab("Depth (m)")+ylab("Layers per 5cm")
 print(ggp) 
 
 #ggsave("fitdiff-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
{
  gicc05=results$original.chron$age[1+1:n]
  ggd = data.frame(depth=results$data$depth,
                   mean=results$simulation$summary$mean-gicc05,
                   lower=results$simulation$summary$lower-gicc05,
                   upper=results$simulation$summary$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)")
  print(ggp)
  
  #ggsave("unsync-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```


## Fixed tie-points


In the paper we demonstrate our model first using the Adolphi tie-points fixed to be equal to the mode of the probability distribution. We omit the first tie-point since it falls outside of our considered interval. The constrained chronologies can be computed as follows.

```{r fixed, eval=TRUE}
library(INLA)
fixedsims = cbind(#rep(inla.mmarginal(adolphipdfs$tie1),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie2),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie3),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie4),nsims),
                  rep(inla.mmarginal(adolphipdfs$tie5),nsims)
                  )
synchronization = list(samples = fixedsims,nsims=nsims,
                       locations=c(#1492.50,
                                   1502.80,1532.70,1767.25,2132.40),
                       locations_unit="depth")
results_fixed = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=synchronization,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=TRUE) ,
                print.progress=TRUE
                )
{
  gicc05=results_fixed$original.chron$age[1+1:n]
  ggd = data.frame(depth=results_fixed$data$depth,
                   mean=results_fixed$simulation$summary_sync$mean-gicc05,
                   lower=results_fixed$simulation$summary_sync$lower-gicc05,
                   upper=results_fixed$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)")
  print(ggp)
  
  #ggsave("fixed-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```

## Uncertain tie-points

Synchronizing our chronologies with the Adolphi tie-points where the uncertainties is incorporated can be done using Monte Carlo simulations. All of this can be done using the bremla function.

```{r sync, eval = TRUE}
library(ggplot2)
library(INLA)
synchronization = list(method="adolphi",nsims=nsims,
                       locations=c(#1492.50,
                                   1502.80,1532.70,1767.25,2132.40),
                       locations_unit="depth")
results_sync = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=synchronization,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=2,summary=list(CI.type="hpd")) ,
                print.progress=TRUE
                )
tiepointranges = as.data.frame(matrix(NA,nrow=4,ncol=3))
gicc05=results_sync$original.chron$age[1+1:n]
gicc05tie = gicc05[results_sync$tie_points$locations_indexes]
colnames(tiepointranges)=c("lower","upper","depth")
for(i in 1:4){
  tiepointranges[i,1:2] = inla.hpdmarginal(0.95,adolphipdfs[[paste0("tie",i+1)]])-gicc05tie[i]
}
tiepointranges[,3] = depth[results_sync$tie_points$locations_indexes]
{
  
  ggd = data.frame(depth=results_sync$data$depth,
                   mean=results_sync$simulation$summary_sync$mean-gicc05,
                   lower=results_sync$simulation$summary_sync$lower-gicc05,
                   upper=results_sync$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    geom_linerange(data=tiepointranges,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp)
  

  
  #ggsave("sync-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```

Excluding the contested fourth tie-point can be done as follows:
```{r sync2, eval = TRUE}
library(ggplot2)
library(INLA)
synchronization = list(method="adolphi",nsims=nsims,
                       locations=c(NA,1502.80,1532.70,NA,2132.40),
                       locations_unit="depth")
results_sync2 = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=synchronization,
                control.fit=list(noise="ar1"),
                control.sim=list(synchronized=TRUE,summary=list(CI.type="hpd")) ,
                print.progress=TRUE
                )
tiepointranges = as.data.frame(matrix(NA,nrow=3,ncol=3))
gicc05=results_sync2$original.chron$age[1+1:n]
gicc05tie = gicc05[results_sync2$tie_points$locations_indexes]
colnames(tiepointranges)=c("lower","upper","depth")
for(i in 1:3){
  tiepointranges[i,1:2] = inla.hpdmarginal(0.95,adolphipdfs[[paste0("tie",c(2,3,5)[i])]])-gicc05tie[i]
}
tiepointranges[,3] = depth[results_sync2$tie_points$locations_indexes]
{
  
  ggd = data.frame(depth=results_sync2$data$depth,
                   mean=results_sync2$simulation$summary_sync$mean-gicc05,
                   lower=results_sync2$simulation$summary_sync$lower-gicc05,
                   upper=results_sync2$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_line(aes(y=mean),col="blue")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    geom_linerange(data=tiepointranges,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp)
  
  # ggsave("sync-no4-4800x2000.eps", device=cairo_ps,width=4800,height=2000,units="px",dpi=500,limitsize=FALSE)
}
```


# Applications




## Abrupt warmings

The onset of abrupt warmings is dated in two stages that are combined to express the complete dating uncertainty, pertaining to the uncertainty originating from both the age-depth relationship as well as estimating the depth in the record which represent the onset of the transition. The latter is estimated using a linear ramp model as described in Erhardt et al. (2019). The linear ramp fit can be performed and plotted as follows.



```{r events_individual, eval=FALSE}
library(stringr)
eventnumber=13 #number between 1 and 29. specifies which transition to consider
#load data window and specifics to transition
lowerints = which.index(event_intervals$depth_int_lower.m, depth[2:length(depth)])
upperints = which.index(event_intervals$depth_int_upper.m, depth[2:length(depth)])
depth.reference = event_intervals$NGRIP_depth_m[eventnumber]
age.reference = event_intervals$GICC_age.yb2k[eventnumber]
interval = lowerints[eventnumber]:upperints[eventnumber]
transitionlabel = str_sub(event_intervals$onsetlabel[eventnumber],
                      str_locate(event_intervals$onsetlabel[eventnumber],"GI")[1])
control.linramp=list(proxy=proxy,
                     interval=interval,
                     interval.unit="index",
                     depth.reference=event_intervals$NGRIP_depth_m[eventnumber]
                     )
results_event = linrampfitter(results_sync,control.linramp)
control.transition_dating = list(label="Simulated transition")
results_event = events_depth_to_age(results_event,
                                    control.transition_dating=control.transition_dating)
results_event0 = linrampfitter(results,control.linramp)
results_event0 = events_depth_to_age(results_event0,
                                    control.transition_dating=control.transition_dating)
results_event2 = linrampfitter(results_sync2,control.linramp)
results_event2 = events_depth_to_age(results_event2,
                                    control.transition_dating=control.transition_dating)
{
  ggd1 = data.frame(depth=depth[interval],proxy=proxy[interval],
                    x=results_event$linramp$data$x,
                    mean=results_event$linramp$linrampfit$mean,
                    lower=results_event$linramp$linrampfit$q0.025,
                    upper=results_event$linramp$linrampfit$q0.975
                    )
  gg1 = ggplot(data=ggd1,aes(x=depth))+geom_line(aes(y=proxy),col="gray")+
    theme_bw()+ xlim(rev(range(depth[interval])))+xlab("Depth (m)")+
    ylab(expression(paste(delta^18,"O (permil)")))+ggtitle("(a) GI-11 Linear ramp fit")+
    geom_ribbon(aes(x=x,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(x=x,y=mean),col="blue",size=0.7)
    
  ybottom = min(results_event$linramp$data$y)
  ytop = min(results_event$linramp$linrampfit$q0.025)
  margt0=results_event$linramp$param$t0$marg.t0
  normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt0[,1],y=normt0.y),aes(x=x,y=y),col="blue")
  
  margt1 = results_event$linramp$param$t1$marginal
  normt1.y = margt1[,2]/diff(range(margt1[,2]))*(ytop-ybottom)-min(margt1[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt1[,1],y=normt1.y),aes(x=x,y=y),col="blue",
                        linetype="dashed")
  
  gg1 = gg1 + geom_vline(aes(xintercept=depth.reference),linetype="dotted",size=0.8)
  
  gd2 = as.data.frame(results_event$linramp$param$t0$marg.t0)
  gg2 = ggplot(data=gd2,mapping=aes(x=x,y=y)) + geom_line()+theme_bw()+
    xlab("Onset depth (m)") + ylab("Density") + ggtitle("(b) Marginal posterior of onset depth")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$mean),col="blue")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$q0.025),col="red")+
    geom_vline(aes(xintercept = results_event$linramp$param$t0$q0.975),col="red")
  
  
  gd3 = as.data.frame(results_event$linramp$param$t1$marginal)
  gg3 = ggplot(data=gd3,mapping=aes(x=x,y=y)) + geom_line()+theme_bw()+
    xlab("Onset depth (m)") + ylab("Density") + ggtitle("(c) Marginal posterior of end-point depth")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$mean),col="blue")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$q0.025),col="red")+
    geom_vline(aes(xintercept = results_event$linramp$param$t1$q0.975),col="red")
  
  
  ggarrange(gg1,ggarrange(gg2,gg3,nrow=1),nrow=2)
  #ggsave("GI-11-rampfit-4800x3000.eps", device=cairo_ps,width=4800,height=3000,units="px",dpi=500,limitsize=FALSE)
  
  gghist = ggplot(data = data.frame(ages=results_event$event_dating$samples)) + theme_bw()+
    geom_histogram(aes(x=ages,y=..density..),fill="orange",col="black")+xlab("Onset age (yb2k)")+
    ylab("Density") + ggtitle("GI-11 Onset age") +
    geom_vline(aes(xintercept = age.reference),lty=3,size=0.8)+
    geom_vline(aes(xintercept=results_event$event_dating$mean),col="blue",size=0.7)+
    geom_vline(aes(xintercept=results_event$event_dating$q0.025),col="red",size=0.7)+
    geom_vline(aes(xintercept=results_event$event_dating$q0.975),col="red",size=0.7)+
    xlim(rev(range(results_event$event_dating$samples)))
  
  #ggsave("GI-11-histogram-4800x3000.eps", device=cairo_ps,width=4800,height=3000,units="px",dpi=500,limitsize=FALSE)
  
  
  
}



{
  
  
  tiepointranges_full = as.data.frame(matrix(NA,nrow=4,ncol=3))
gicc05=results_sync$original.chron$age[1+1:n]
gicc05tie = gicc05[results_sync$tie_points$locations_indexes]
colnames(tiepointranges)=c("lower","upper","depth")
for(i in 1:4){
  tiepointranges_full[i,1:2] = inla.hpdmarginal(0.95,adolphipdfs[[paste0("tie",c(2,3,4,5)[i])]])-gicc05tie[i]
}
tiepointranges_full[,3] = depth[results_sync$tie_points$locations_indexes]
colnames(tiepointranges_full) = c("lower","upper","depth")  

  ggd = data.frame(depth=results_sync2$data$depth,
                   mean0=results$simulation$summary$mean-gicc05,
                   lower0=results$simulation$summary$lower-gicc05,
                   upper0=results$simulation$summary$upper-gicc05,
                   mean=results_sync$simulation$summary_sync$mean-gicc05,
                   lower=results_sync$simulation$summary_sync$lower-gicc05,
                   upper=results_sync$simulation$summary_sync$upper-gicc05,
                   mean2=results_sync2$simulation$summary_sync$mean-gicc05,
                   lower2=results_sync2$simulation$summary_sync$lower-gicc05,
                   upper2=results_sync2$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_ribbon(aes(ymin=lower0,ymax=upper0),fill="cyan2",col="cyan2",alpha=0.3)+
    geom_line(aes(y=mean0),col="brown")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(y=mean),col="blue")+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    ggtitle("(a) Simulated chronologies")+
    geom_linerange(data=tiepointranges_full,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp)
  
  
  ggp1 = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_ribbon(aes(ymin=lower2,ymax=upper2),fill="cyan2",col="cyan2",alpha=0.3)+
    geom_line(aes(y=mean2),col="brown")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(y=mean),col="blue")+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    ggtitle("(a) Synchronized chronologies")+
    geom_linerange(data=tiepointranges_full,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp1)
  
  
   ggd1 = data.frame(depth=depth[interval],proxy=proxy[interval],
                    x=results_event$linramp$data$x,
                    mean=results_event$linramp$linrampfit$mean,
                    lower=results_event$linramp$linrampfit$q0.025,
                    upper=results_event$linramp$linrampfit$q0.975
                    )
  gg1 = ggplot(data=ggd1,aes(x=depth))+geom_line(aes(y=proxy),col="gray")+
    theme_bw()+ 
    #xlim(rev(range(depth[interval])))+
    xlim(c(2161,2155.3))+
    xlab("Depth (m)")+
    ylab(expression(paste(delta^18,"O (permil)")))+ggtitle("(b) GI-11 Linear ramp fit")+
    geom_ribbon(aes(x=x,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(x=x,y=mean),col="blue",size=0.7)
    
  ybottom = min(results_event$linramp$data$y)
  ytop = min(results_event$linramp$linrampfit$q0.025)
  margt0=results_event$linramp$param$t0$marg.t0
  normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt0[,1],y=normt0.y),aes(x=x,y=y),col="brown",size=1.0)
  
  gghist = ggplot(data = data.frame(ages=results_event$event_dating$samples)) + theme_bw()+
    geom_histogram(aes(x=ages,y=..density..),fill="orange",col="black")+xlab("Onset age (yb2k)")+
    ylab("Density") + ggtitle("(c) GI-11 Onset age") +
    geom_vline(aes(xintercept = age.reference),lty=3,size=0.8)+
    # geom_vline(aes(xintercept=results_event$event_dating$mean),col="blue",size=0.7)+
    # geom_vline(aes(xintercept=results_event$event_dating$q0.025),col="red",size=0.7)+
    # geom_vline(aes(xintercept=results_event$event_dating$q0.975),col="red",size=0.7)+
    xlim(rev(range(results_event$event_dating$samples)))
  
  
  library(stringr)
  

  
ggl = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="Synchronous chronology mean"))+
  geom_line(aes(x=x1,y=y1,col="Synchronous chronology 95% CI"))+
  geom_line(aes(x=x2,y=y2,col="Unsynchronous chronology mean"))+
  geom_line(aes(x=x,y=y,col="Unsynchronous chronology 95% CI"))+
  geom_line(aes(x=x,y=y,col="Tie point 95% CI"))+
  scale_color_manual("",values=c("Synchronous chronology mean"="blue",
                                "Synchronous chronology 95% CI"="red",
                                "Unsynchronous chronology mean"="brown",
                                "Unsynchronous chronology 95% CI"="cyan2",
                                "Tie point 95% CI"="magenta"),
                       breaks=c("Synchronous chronology mean",
                                "Synchronous chronology 95% CI",
                                "Unsynchronous chronology mean",
                                "Unsynchronous chronology 95% CI",
                                "Tie point 95% CI")
                                 )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        # legend.text = element_text(size = 17),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.size = unit(0.8,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(0.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )


ggl1 = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="\n(a) Chronology mean\n(b) Linear ramp mean\n"))+
  geom_line(aes(x=x1,y=y1,col="(a) Chronology 95% CI\n(b) Linear ramp 95% CI"))+
  geom_line(aes(x=x2,y=y2,col="\n(a) Chronology mean, tie point 4 excluded\n(b) Onset posterior distribution\n"))+
  geom_line(aes(x=x,y=y,col="(a) Chronology 95% CI, tie point 4 excluded"))+
  geom_line(aes(x=x,y=y,col="\n(a) Tie point 95% CI\n"))+
  geom_line(aes(x=x,y=y,col="(b) d18O data"))+
  scale_color_manual("",values=c("\n(a) Chronology mean\n(b) Linear ramp mean\n"="blue",
                                "(a) Chronology 95% CI\n(b) Linear ramp 95% CI"="red",
                                "\n(a) Chronology mean, tie point 4 excluded\n(b) Onset posterior distribution\n"="brown",
                                "(a) Chronology 95% CI, tie point 4 excluded"="cyan2",
                                "\n(a) Tie point 95% CI\n"="magenta",
                                "(b) d18O data"="gray"),
                       breaks=c("\n(a) Chronology mean\n(b) Linear ramp mean\n",
                                "(a) Chronology 95% CI\n(b) Linear ramp 95% CI",
                                "\n(a) Chronology mean, tie point 4 excluded\n(b) Onset posterior distribution\n",
                                "(a) Chronology 95% CI, tie point 4 excluded",
                                "\n(a) Tie point 95% CI\n",
                                "(b) d18O data")
                                 )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.height=unit(0.3,"cm"),
        # legend.key.size = unit(17,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(1.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )


  #(a) (b) and (c) legends in same legend (maybe such that blue means something in a and something in b etc)
  plots = c()
  plots[[1]] = ggp
  plots[[2]] = ggl
  plots[[3]] = gg1
  plots[[4]] = gghist


  ggarrange(plotlist=plots,nrow=2,ncol=2)
  # ggsave("multiplot-unsync-3000x2000.eps",device=cairo_ps,width=3000,height=2000,units="px",limitsize=FALSE)
  
  plots1 = c()
  plots1[[1]] = ggp1
  plots1[[2]] = ggl1
  plots1[[3]] = gg1
  plots1[[4]] = gghist


  ggarrange(plotlist=plots1,nrow=2,ncol=2,widths = c(0.67,0.5,0.5,0.5))
  plotrow1 = c()
  plotrow1[[1]] = ggp1
  plotrow1[[2]] = ggl1
  plotrow2 = c()
  plotrow2[[1]] = gg1
  plotrow2[[2]] = gghist
  ggarow1 = ggarrange(plotlist=plotrow1,widths=c(0.7,0.3))
  ggarow2 = ggarrange(plotlist=plotrow2)
  
  ggarrange(c(ggarow1,ggarow2),nrow=2)
  
  ggarrange(plotlist= c(ggarrange(plotlist=plotrow1,widths=c(0.67,0.33)),
            ggarrange(plotlist=plotrow1,widths=c(0.5,0.5))) )
  # ggsave("multiplot-sync-no4-2200x4000.eps",device=cairo_ps,height=2200,width=4000,units="px",limitsize=FALSE)
  #
  
}

```

```{r multifig-all, eval=FALSE}

eventdepth = results_event$linramp$param$t0$mean
  tiepointranges_full = as.data.frame(matrix(NA,nrow=4,ncol=3))
gicc05=results_sync$original.chron$age[1+1:n]
gicc05tie = gicc05[results_sync$tie_points$locations_indexes]
colnames(tiepointranges)=c("lower","upper","depth")
for(i in 1:4){
  tiepointranges_full[i,1:2] = inla.hpdmarginal(0.95,adolphipdfs[[paste0("tie",c(2,3,4,5)[i])]])-gicc05tie[i]
}
tiepointranges_full[,3] = depth[results_sync$tie_points$locations_indexes]
colnames(tiepointranges_full) = c("lower","upper","depth")  

  ggd = data.frame(depth=results_sync2$data$depth,
                   mean0=results$simulation$summary$mean-gicc05,
                   lower0=results$simulation$summary$lower-gicc05,
                   upper0=results$simulation$summary$upper-gicc05,
                   mean=results_sync$simulation$summary_sync$mean-gicc05,
                   lower=results_sync$simulation$summary_sync$lower-gicc05,
                   upper=results_sync$simulation$summary_sync$upper-gicc05,
                   mean2=results_sync2$simulation$summary_sync$mean-gicc05,
                   lower2=results_sync2$simulation$summary_sync$lower-gicc05,
                   upper2=results_sync2$simulation$summary_sync$upper-gicc05,
                   zeros = numeric(n))
  
  
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    coord_cartesian(ylim=c(range(ggd$lower0,ggd$upper))) +
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_ribbon(aes(ymin=lower0,ymax=upper0),fill="black",col="black",alpha=0.3)+
    geom_ribbon(aes(ymin=lower2,ymax=upper2),fill="red",col="red",alpha=0.3)+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="blue",col="blue",alpha=0.3)+
    geom_line(aes(y=mean0),col="black",size=0.9)+
    geom_line(aes(y=mean2),col="red",size=0.9)+
    geom_line(aes(y=mean),col="blue",size=0.9)+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    ggtitle("(a) Simulated chronologies")+
    geom_linerange(data=data.frame(depth=eventdepth),
                   aes(x=depth,ymin=-500,ymax=1000),
                   col="magenta",size=0.8)+
    geom_linerange(data=tiepointranges_full,aes(x=depth,ymin=lower,ymax=upper),color="green",
                   size=0.8)
  print(ggp)
  
  
  ggp1 = ggplot(data=ggd,aes(x=depth)) + theme_bw()+
    #geom_line(aes(y=zeros),color="gray",linetype="dashed")+
    geom_ribbon(aes(ymin=lower2,ymax=upper2),fill="cyan2",col="cyan2",alpha=0.3)+
    geom_line(aes(y=mean2),col="black")+
    geom_ribbon(aes(ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(y=mean),col="blue")+
    xlab("Depth (m)") + ylab("Simulated time scale - GICC05 (years)") +
    ggtitle("(a) Synchronized chronologies")+
    geom_linerange(data=tiepointranges_full,aes(x=depth,ymin=lower,ymax=upper),color="magenta")
  print(ggp1)
  
  
   ggd1 = data.frame(depth=depth[interval],proxy=proxy[interval],
                    x=results_event$linramp$data$x,
                    mean=results_event$linramp$linrampfit$mean,
                    lower=results_event$linramp$linrampfit$q0.025,
                    upper=results_event$linramp$linrampfit$q0.975,
                    mean0=results_event0$linramp$linrampfit$mean,
                    lower0=results_event0$linramp$linrampfit$q0.025,
                    upper0=results_event0$linramp$linrampfit$q0.975,
                    mean2=results_event2$linramp$linrampfit$mean,
                    lower2=results_event2$linramp$linrampfit$q0.025,
                    upper2=results_event2$linramp$linrampfit$q0.975
                    )
  gg1 = ggplot(data=ggd1,aes(x=depth))+geom_line(aes(y=proxy),col="gray")+
    theme_bw()+ 
    #xlim(rev(range(depth[interval])))+
    xlim(c(2161,2155.3))+
    xlab("Depth (m)")+
    ylab(expression(paste(delta^18,"O (permil)")))+ggtitle("(b) GI-11 Linear ramp fit")+
    geom_ribbon(aes(x=x,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.3)+
    geom_line(aes(x=x,y=mean),col="blue",size=0.7)
    
  ybottom = min(results_event$linramp$data$y)
  ytop = min(results_event$linramp$linrampfit$q0.025)
  margt0=results_event$linramp$param$t0$marg.t0
  normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
  gg1 = gg1 + geom_line(data=data.frame(x=margt0[,1],y=normt0.y),aes(x=x,y=y),col="black",size=1.0)
  
  ggdhistfull = data.frame(ages=results_event$event_dating$samples,
                  ages0 = results_event0$event_dating$samples,
                  ages2 = results_event2$event_dating$samples)
  gghistfull = ggplot(data = ggdhistfull) + 
    theme_bw()+
    geom_histogram(aes(x=ages,y=..density..),fill="red",col="red",alpha=0.3)+
    xlab("Onset age (yb2k)")+
    geom_histogram(aes(x=ages2,y=..density..),fill="blue",col="blue",alpha=0.3)+
    geom_histogram(aes(x=ages0,y=..density..),fill="black",col="black",alpha=0.3)+
    ylab("Density") + ggtitle("(c) GI-11 Onset age") +
    # geom_vline(aes(xintercept = age.reference),lty=3,size=0.8)+
    # geom_vline(aes(xintercept=results_event$event_dating$mean),col="blue",size=0.7)+
    # geom_vline(aes(xintercept=results_event$event_dating$q0.025),col="red",size=0.7)+
    # geom_vline(aes(xintercept=results_event$event_dating$q0.975),col="red",size=0.7)+
    xlim(rev(range(results_event$event_dating$samples,results_event0$event_dating$samples)))
  
  gghist1 = ggplot(data = ggdhistfull) + 
    theme_bw()+
    geom_histogram(aes(x=ages,y=..density..),fill="orange",col="black",alpha=1)+
    xlab("Onset age (yb2k)")+
    ylab("Density") +
    ggtitle("(i) Synchronized") +
    xlim(rev(range(results_event$event_dating$samples,results_event0$event_dating$samples)))
  gghist2 = ggplot(data = ggdhistfull) + 
    theme_bw()+
    geom_histogram(aes(x=ages2,y=..density..),fill="orange",col="black",alpha=1)+
    xlab("Onset age (yb2k)")+
    ylab("Density") +
    ggtitle("(ii) Synchronized without tie point 4") +
    xlim(rev(range(results_event$event_dating$samples,results_event0$event_dating$samples)))
  gghist0 = ggplot(data = ggdhistfull) + 
    theme_bw()+
    geom_histogram(aes(x=ages0,y=..density..),fill="orange",col="black",alpha=1)+
    xlab("Onset age (yb2k)")+
    ylab("Density") +
    ggtitle("(iii) Unsynchronized") +
    xlim(rev(range(results_event$event_dating$samples,results_event0$event_dating$samples)))
  
  histlist = c()
  histlist[[1]] = gghist1
  histlist[[2]] = gghist2
  histlist[[3]] = gghist0
  gghistlist = ggarrange(plotlist=histlist,nrow=3,ncol=1)
  
  library(stringr)
  

  

gglg1 = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n"))+
  geom_line(aes(x=x1,y=y1,col="(a) Synchronous chronology mean and 95% CI, tie point 4 excluded\n(b) Linear ramp 95% CI"))+
  geom_line(aes(x=x2,y=y2,col="\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset depth posterior distribution\n"))+
  geom_line(aes(x=x,y=y,col="(a) Tie point 95% CI"))+
  geom_line(aes(x=x,y=y,col="\n(b) GI-11 d18O data\n"))+
  scale_color_manual("",values=c("\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n"="blue",
                                "(a) Synchronous chronology mean and 95% CI, tie point 4 excluded\n(b) Linear ramp 95% CI"="red",
                                "\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset depth posterior distribution\n"="black",
                                "(a) Tie point 95% CI"="green",
                                "\n(b) GI-11 d18O data\n"="gray"),
                       breaks=c("\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n",
                                "(a) Synchronous chronology mean and 95% CI, tie point 4 excluded\n(b) Linear ramp 95% CI",
                                "\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset depth posterior distribution\n",
                                "(a) Tie point 95% CI",
                                "\n(b) GI-11 d18O data\n")
                                 )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.height=unit(0.3,"cm"),
        # legend.key.size = unit(17,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(1.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )
gglg2 = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n"))+
  geom_line(aes(x=x1,y=y1,col="(a) Synchronous chronology mean and 95% CI, \n      tie point 4 excluded\n(b) Linear ramp 95% CI"))+
  geom_line(aes(x=x2,y=y2,col="\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset posterior distribution\n"))+
  geom_line(aes(x=x,y=y,col="(a) Tie point 95% CI"))+
  geom_line(aes(x=x,y=y,col="\n(a) Depth of event GI-11\n"))+
  geom_line(aes(x=x,y=y,col="(b) GI-11 d18O data"))+
  scale_color_manual("",values=c("\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n"="blue",
                                "(a) Synchronous chronology mean and 95% CI, \n      tie point 4 excluded\n(b) Linear ramp 95% CI"="red",
                                "\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset posterior distribution\n"="black",
                                "(a) Tie point 95% CI"="green",
                                "\n(a) Depth of event GI-11\n"="magenta",
                                "(b) GI-11 d18O data"="gray"),
                       breaks=c("\n(a) Synchronous chronology mean and 95% CI\n(b) Linear ramp mean\n",
                                "(a) Synchronous chronology mean and 95% CI, \n      tie point 4 excluded\n(b) Linear ramp 95% CI",
                                "\n(a) Unsynchronous chronology mean and 95%CI\n(b) Onset posterior distribution\n",
                                "(a) Tie point 95% CI",
                                "\n(a) Depth of event GI-11\n",
                                "(b) GI-11 d18O data")
                                 )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.height=unit(0.3,"cm"),
        # legend.key.size = unit(17,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(1.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )


  #(a) (b) and (c) legends in same legend (maybe such that blue means something in a and something in b etc)
  
  plots = c()
  plots[[1]] = ggp
  plots[[2]] = gglg1
  plots[[3]] = gg1
  plots[[4]] = gghistfull

  
  aaa = grid.arrange(ggp,gglg1,gg1,gghistlist,
               layout_matrix=rbind(c(1,1,1,1,2,2),
                                   c(3,3,3,4,4,4)))
  bbb = arrangeGrob(ggp,gglg2,gg1,gghistlist,
               layout_matrix=rbind(c(1,1,1,1,2,2),
                                   c(3,3,3,4,4,4)))

  #ggarrange(plotlist=plots,nrow=2,ncol=2)
  ggsave("multiplot-new2-4000x3000.eps",plot=bbb,device=cairo_ps,width=4000,height=3000,units="px",limitsize=FALSE)
  
  
  cairo_ps(filename = "multiplot.eps",
         width = 7, height = 7, pointsize = 12,
         fallback_resolution = 300)
plot(aaa)
dev.off()
  
  plots1 = c()
  plots1[[1]] = ggp
  plots1[[2]] = gglg1
  plots1[[3]] = gg1
  plots1[[4]] = gghistlist


  ggarrange(plotlist=plots1,nrow=2,ncol=2)
  # ggsave("multiplot-new22-3500x2800.eps",device=cairo_ps,width=3500,height=2800,units="px",limitsize=FALSE)
  #

```

We want to compare the dating onsets with those given by Rasmussen et al. (2014), Capron (2021) and Buizert et al. (2015). We start by importing those values

```{r events_import, eval=FALSE}
##### IMPORT MYRVOLL-NILSEN 2022 DATA AND COMPARE POSTERIORS ####
library(readxl)
rasmussen_depths = event_intervals$NGRIP_depth_m
rasmussen_ages = event_intervals$GICC_age.yb2k #GISevents$`Age (a b2k)`
buizert_onsets = read_excel("data/Buizert_onsets.xlsx",
                            col_types=c("text","numeric","numeric","numeric","numeric"))
buizert_depths = buizert_onsets$Depth; buizert_ages = buizert_onsets$Age
#buizert_depths[c(2:6,8:9,12:13,15:17,19:21)]
buizert_ages = buizert_ages[c(2:6,8:9,12:13,15:17,19:21)]
capron_onsets_NGRIP_d18O = read_excel("data/Capron_onsets.xls",
                           sheet="d18O",n_max=25)
capron_ages_NGRIP_d18O = capron_onsets_NGRIP_d18O$`t1 (50%)`
corrick_onsets = read_excel("data/Corrick_onsets.xlsx")
corrick_ages = corrick_onsets$`SIOC19 age`

capind = numeric(29); buiind = numeric(29); corind = numeric(29)

capind = c(NA,2,3, 4,5,6,NA,NA,7,8,NA,9,10,11,NA,NA,NA,NA,NA,12,13,14,NA,NA,15,NA,NA,16,17)
buiind = c(NA,2,NA,3,4,6,NA,NA,8,9,NA,11,12,13,NA,NA,NA,NA,NA,15,16,17,NA,NA,19,NA,NA,20,21)
corind = c(NA,1,NA,2,3,5,6,NA,8,9,10,11,12,13,NA,15,NA,16,NA,NA,NA,17,NA,19,20,21,NA,22,23)


```

```{r adolphilinrampfitter}
adolphi_transfer = read.table("data/Adolphi_CP2018_SI.txt",skip=6,header=FALSE)
adolphi_transfer[,1] = adolphi_transfer[,1] + 50
adolphi_transfer_mean = adolphi_transfer[,2]
adolphi_transfer_lower = adolphi_transfer[,5]
adolphi_transfer_upper = adolphi_transfer[,6]


ngrip_to_gicc05 = splinefun(results_sync$data$depth,results_sync$data$age) #interpolate age as function of depth

maxdepth = 2181.87
adolphidepth = results_sync$data$depth[results_sync$data$depth<maxdepth]

adolphi_offset_mean_spline = function(depth){
  gicc05_age = ngrip_to_gicc05(depth)
  spline = splinefun(adolphi_transfer[,1], adolphi_transfer_mean) #as a function of gicc05 age
  return(spline(gicc05_age))
}
adolphi_offset_lower_spline = function(depth){
  gicc05_age = ngrip_to_gicc05(depth)
  spline = splinefun(adolphi_transfer[,1], adolphi_transfer_lower) #as a function of gicc05 age
  return(spline(gicc05_age))
}
adolphi_offset_upper_spline = function(depth){
  gicc05_age = ngrip_to_gicc05(depth)
  spline = splinefun(adolphi_transfer[,1], adolphi_transfer_upper) #as a function of gicc05 age
  return(spline(gicc05_age))
}

adolphi_offset_mean = adolphi_offset_mean_spline(adolphidepth)
adolphi_offset_lower = adolphi_offset_lower_spline(adolphidepth)
adolphi_offset_upper = adolphi_offset_upper_spline(adolphidepth)



ggd_adolphi = data.frame(depth=adolphidepth,mean=adolphi_offset_mean,lower=adolphi_offset_lower, upper=adolphi_offset_upper)

gicc05 = results_sync$data$age
ggd_sync = data.frame(depth = results_sync$data$depth, age=results_sync$data$age, mean=results_sync$simulation$summary_sync$mean-gicc05, lower = results_sync$simulation$summary_sync$lower-gicc05, upper=results_sync$simulation$summary_sync$upper-gicc05)

tie_indexes = results_sync$tie_points$locations_indexes
adolphi_tie_mean = adolphi_offset_mean_spline(results_sync$data$depth[tie_indexes])
adolphi_tie_lower = adolphi_offset_lower_spline(results_sync$data$depth[tie_indexes])
adolphi_tie_upper = adolphi_offset_upper_spline(results_sync$data$depth[tie_indexes])

ggd_tie = data.frame(depths = results_sync$data$depth[tie_indexes], mean = results_sync$simulation$summary_sync$mean[tie_indexes]-gicc05tie, lower = results_sync$simulation$summary_sync$lower[tie_indexes]-gicc05tie, upper = results_sync$simulation$summary_sync$upper[tie_indexes]-gicc05tie)

ggd_tie_adolphi = data.frame(depths = results_sync$data$depth[tie_indexes],
                             mean = adolphi_tie_mean,
                             lower = adolphi_tie_lower,
                             upper = adolphi_tie_upper)

ggp_adolphi =ggplot() + theme_bw() +
  geom_ribbon(data=ggd_adolphi,aes(x=depth,ymin=lower,ymax=upper),fill="black",col="black",alpha=0.2) +
  geom_ribbon(data=ggd_sync,aes(x=depth,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.2) +
  
  geom_line(data=ggd_adolphi,aes(x=depth,y=mean),col="black",size=1)+
  geom_line(data=ggd_sync,aes(x=depth,y=mean),col="red",size=1)+
  geom_segment(data=ggd_tie_adolphi,aes(x=depths,xend=depths,y=lower,yend=upper), 
               col="black",size=0.7)+
  geom_segment(data=ggd_tie,mapping=aes(x=depths,xend=depths,y=lower,yend=upper), 
               col="red",size=0.7)+
  xlab("NGRIP depth (m)") + 
  ylab("Synchronous time scale - GICC05 (years)")

plot(ggp_adolphi)


adolphiage = results$data$age[results$data$age<=45000]
meanspline = splinefun(adolphi_transfer[,1], adolphi_transfer_mean) 
lowerspline = splinefun(adolphi_transfer[,1], adolphi_transfer_lower) 
upperspline = splinefun(adolphi_transfer[,1], adolphi_transfer_upper) 

ggd_adolphi_age = data.frame(depth=adolphidepth, age = adolphiage,mean=meanspline(adolphiage), lower=lowerspline(adolphiage), upper=upperspline(adolphiage))


ggp_adolphi_age =ggplot() + theme_bw() +
  geom_ribbon(data=ggd_adolphi_age,aes(x=age,ymin=lower,ymax=upper),fill="black",col="black",alpha=0.2) +
  geom_ribbon(data=ggd_sync,aes(x=age,ymin=lower,ymax=upper),fill="red",col="red",alpha=0.2) +
  
  geom_line(data=ggd_adolphi_age,aes(x=age,y=mean),col="black",size=1)+
  geom_line(data=ggd_sync,aes(x=age,y=mean),col="red",size=1)+
  xlab("NGRIP depth (m)") + 
  ylab("GICC05 age (yr b2k)")+
  xlim(results_sync$data$age[1],45000)

plot(ggp_adolphi_age)
ggsave("adolphicomparison-3500x1500.eps",device=cairo_ps,width=3500,height=1500,units="px",limitsize=FALSE)
#####
# 
# ylim = range(adolphi_offset_mean,adolphi_offset_upper,adolphi_offset_lower)
# plot(adolphidepth,adolphi_offset_mean,col="blue",type="l",ylim=ylim)
# lines(adolphidepth,adolphi_offset_lower,col="red")
# lines(adolphidepth,adolphi_offset_upper,col="red")
# 
#   
# adolphi_offset_lower_spline = splinefun(results_sync$data$depth, adolphi_transfer_lower) #as a function of depth
# adolphi_offset_upper_spline = splinefun(results_sync$data$depth, adolphi_transfer_upper) #as a function of depth
# 
adolphi_age_to_offset = splinefun(adolphi_transfer$V1,adolphi_transfer$V2) #take inn GICC05 age, gives offset
# 
adolphi_depth_to_corrected = function(depth){

  gicc05_age = ngrip_to_gicc05(depth)
  corrected = gicc05_age + adolphi_age_to_offset( gicc05_age  )
  return(corrected)
}

#  test = adolphi_depth_to_corrected(depth[age<45000])
#  plot(test-age[age<45000])
maxadolphidepth = max(depth[age<45000])


```

We then estimate the dating uncertainty for all 29 events
```{r compare_transitions_1}
agesimmatrix_d18O = matrix(NA,29,nsims)
agesimmatrix_d18O_unsync = matrix(NA,29,nsims)
agesimmatrix_d18O_no4 = matrix(NA,29,nsims)
adolphimeans = rep(NA,29)
depthlist_d18O = c()
do.plot.rampfit = TRUE
do.plot.agehist = FALSE
depthstats = as.data.frame(matrix(NA,4,29))
colnames(depthstats) = c("true", "mean", "CIL","CIU","dustmean","dustCIL","dustCIU")
agestats = as.data.frame(matrix(NA,4,29))
colnames(agestats) = c("true", "mean", "CIL","CIU","dustmean","dustCIL","dustCIU")
steplengths = rep(0.01,29)
steplengths[21]=0.001 #sometimes changing the steplength slightly might improve convergence (default is 0.01)
for(eventnumber in 1:29){
  
  transitionlabel = str_sub(event_intervals$onsetlabel[eventnumber],
                      str_locate(event_intervals$onsetlabel[eventnumber],"GI")[1])
  cat(eventnumber,". Event: ",transitionlabel,"\n",sep="")
  lowerints = which.index(event_intervals$depth_int_lower.m, results_sync$data$depth)
  upperints = which.index(event_intervals$depth_int_upper.m, results_sync$data$depth)
  interval = lowerints[eventnumber]:upperints[eventnumber]
  
  depth.reference = event_intervals$NGRIP_depth_m[eventnumber]
  age.reference = event_intervals$GICC_age.yb2k[eventnumber]
  
  control.linramp = list(proxy=proxy,interval=interval,interval.unit="index",
                         depth.ref=depth.reference, 
                         label=paste0(eventnumber," (d18O):", event_intervals[eventnumber,2])
                         )
  
  
  temp_d18O = linrampfitter(results_sync,control.linramp)
  if(sum(temp_d18O$linramp$param$t0$marg.t0[,1]>maxadolphidepth)==0){
    adolphimeans[eventnumber] = adolphi_depth_to_corrected(temp_d18O$linramp$param$t0$mean)
  }
  temp_d18O_no4 = linrampfitter(results_sync2,control.linramp)
  if(do.plot.rampfit){
    {plot(depth[interval],proxy[interval],type="l",col="gray",
          xlim=rev(range(depth[interval])), xlab="Depth (m)",ylab=expression(paste(delta^18,"O (permil)")),
          main=paste0(eventnumber,": ", transitionlabel))
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$mean)
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$q0.025,col="red")
      lines(temp_d18O$linramp$data$x,temp_d18O$linramp$linrampfit$q0.975,col="red")
      abline(v=rasmussen_depths[eventnumber],lty=3)
      
      ybottom = min(temp_d18O$linramp$data$y)
      ytop = min(temp_d18O$linramp$linrampfit$q0.025)
      margt0=temp_d18O$linramp$param$t0$marg.t0
      normt0.y = margt0[,2]/diff(range(margt0[,2]))*(ytop-ybottom)-min(margt0[,2])+ybottom
      lines(x=margt0[,1],y=normt0.y,col="blue",lwd=2)
      ybottom = min(temp_d18O$linramp$data$y)
      ytop = min(temp_d18O$linramp$linrampfit$q0.025)
      margt1 = temp_d18O$linramp$param$t1$marginal
      normt1.y = margt1[,2]/diff(range(margt1[,2]))*(ytop-ybottom)-min(margt1[,2])+ybottom
      lines(x=margt1[,1],y=normt1.y,col="blue",lwd=2,lty=3)
    }
  }
  
  
  control.transition_dating=list(label="d18O")
  agetemp_d18O = events_depth_to_age(temp_d18O,control.transition_dating)
  agetemp_d18O_no4 = events_depth_to_age(temp_d18O_no4,control.transition_dating)
  agetemp_d18O_unsync = events_depth_to_age(temp_d18O,
                                            control.transition_dating=list(label="d18O",
                                                                           sync=FALSE))
  
  
  agesimmatrix_d18O[eventnumber,] = agetemp_d18O$event_dating$samples 
  agesimmatrix_d18O_no4[eventnumber,] = agetemp_d18O_no4$event_dating$samples 
  agesimmatrix_d18O_unsync[eventnumber,] = agetemp_d18O_unsync$event_dating$samples 
  if(do.plot.agehist){
    hist(agesimmatrix_d18O[eventnumber,],freq=0,breaks=50,col="orange",main=paste0("Onset age: ",transitionlabel),xlab="Age (yb2k)")
    abline(v=age.reference,col="blue")
  }
  
  #Store summary statistics
  depthstats[1,eventnumber] = event_intervals$NGRIP_depth_m[eventnumber]
  depthstats[2,eventnumber] = agetemp_d18O$linramp$param$t0$mean
  depthstats[3,eventnumber] = agetemp_d18O$linramp$param$t0$q0.025
  depthstats[4,eventnumber] = agetemp_d18O$linramp$param$t0$q0.975
  
  densage = density(agesimmatrix_d18O[eventnumber,]); densage = data.frame(x=densage$x,y=densage$y)
  
  zage = inla.zmarginal(densage,silent=TRUE)
  
  agestats[1,eventnumber] = event_intervals$GICC_age.yb2k[eventnumber]
  agestats[2,eventnumber] = mean(agesimmatrix_d18O[eventnumber])
  agestats[3,eventnumber] = zage$quant0.025
  agestats[4,eventnumber] = zage$quant0.975
  
}
```


```{r compare_transitions_2}

  # library(cowplot)
  
  ggplots = c()

  for(i in 1:29){
    dens = density(agesimmatrix_d18O[i,])
    dens = data.frame(x=dens$x,y=dens$y)#/max(dens2$y))
    dens2 = density(agesimmatrix_d18O_no4[i,])
    dens2 = data.frame(x=dens2$x,y=dens2$y)#/max(dens2$y))
    densunsync = density(agesimmatrix_d18O_unsync[i,])
    densunsync = data.frame(x=densunsync$x,y=densunsync$y)#/max(dens2$y))
    xlim = rev(range(dens$x,densunsync$x,dens2$x))
    if(!is.na(adolphimeans[i])){
      xlim=rev(range(xlim,adolphimeans[i]))
    }
    
    ggd = data.frame(x=dens$x,y=dens$y,x0=densunsync$x,y0=densunsync$y,
                     x2=dens2$x,y2=dens2$y)
    ggdrasmus = data.frame(rasmus=event_intervals$GICC_age.yb2k[i])
    title = str_sub(event_intervals[i,2],str_locate(event_intervals[i,2],"GI-")[1])
    
    
    
    gg = ggplot(data=ggd) + theme_bw()+xlim(xlim)+
      geom_line(aes(x=x0,y=y0),col="gray",size=0.7)+
      geom_line(aes(x=x2,y=y2),col="black",size=0.7,linetype="dashed")+
      geom_line(aes(x=x,y=y),col="black",size=0.7)+
      xlab("Onset year (yb2k)")+ylab("Density") +
      ggtitle(title)+
      theme(axis.text.y=element_blank(),
            axis.ticks.y=element_blank())+
      # geom_vline(aes(xintercept = event_intervals$GICC_age.yb2k[i]),col="blue",size=0.7)
      geom_vline(data=ggdrasmus, aes(xintercept = rasmus),col="blue",size=0.7)
    
      
      

  if(!is.na(buiind[i])){
    ggdbuizert = data.frame(buizert=buizert_onsets$Age[buiind[i]])
    gg = gg + geom_vline(data=ggdbuizert,aes(xintercept = buizert),col="green",size=0.7)
    #abline(v=buizert_onsets$Age[buiind[i]],col="green")
    #abline(v=buizert_ages[buiind[i]],col="green")
  }

  if(!is.na(capind[i])){
    ggdcapron = data.frame(capron=capron_ages_NGRIP_d18O[capind[i]])
    gg = gg + geom_vline(data=ggdcapron,aes(xintercept = capron),col="red",size=0.7)
    # abline(v=capron_ages_NGRIP_d18O[capind[i]],col="red")
  }
   if(!is.na(corind[i])){
    ggdcorrick = data.frame(corrick=corrick_onsets$`SIOC19 age`[corind[i]])
    gg = gg + geom_vline(data=ggdcorrick,aes(xintercept = corrick),col="brown",size=0.7)
    #abline(v=buizert_onsets$Age[buiind[i]],col="green")
    #abline(v=buizert_ages[buiind[i]],col="green")
  }
  if(!is.na(adolphimeans[i])){
    ggdadolphi = data.frame(adolphi=adolphimeans[i])
    gg = gg + geom_vline(data=ggdadolphi,aes(xintercept = adolphi),col="purple",size=0.7)
    #abline(v=buizert_onsets$Age[buiind[i]],col="green")
    #abline(v=buizert_ages[buiind[i]],col="green")
  }
    # ggplots = c(ggplots,list(gg))
    ggplots[[i]] = gg
    
  }
  


ggl = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="Synchronized onset posterior",linetype="Synchronized onset posterior"))+
  geom_line(aes(x=x1,y=y1,col="Synchronized onset posterior (tie-point 4 excluded)",linetype="Synchronized onset posterior (tie-point 4 excluded)"))+
  geom_line(aes(x=x2,y=y2,col="Unsynchronized onset posterior",linetype="Unsynchronized onset posterior"))+
  geom_line(aes(x=x,y=y,col="Rasmussen et al. (2014)",linetype="Rasmussen et al. (2014)"))+
  geom_line(aes(x=x1,y=y1,col="Buizert et al. (2015)",linetype="Buizert et al. (2015)"))+
  geom_line(aes(x=x2,y=y2,col="Capron et al. (2021)",linetype="Capron et al. (2021)"))+
  geom_line(aes(x=x,y=y,col="Corrick et al. (2020)",linetype="Corrick et al. (2020)"))+
  geom_line(aes(x=x,y=y,col="Adolphi et al. (2018)",linetype="Adolphi et al. (2018)"))+
  scale_color_manual("",values=c("Synchronized onset posterior"="black",
                                "Synchronized onset posterior (tie-point 4 excluded)"="grey1",
                                "Unsynchronized onset posterior"="gray",
                                "Rasmussen et al. (2014)"="blue",
                                "Buizert et al. (2015)"="green",
                                "Capron et al. (2021)"="red",
                                "Corrick et al. (2020)"="brown",
                                "Adolphi et al. (2018)"="purple"),
                       breaks=c("Synchronized onset posterior",
                                "Synchronized onset posterior (tie-point 4 excluded)",
                                "Unsynchronized onset posterior",
                                "Adolphi et al. (2018)",
                                "Rasmussen et al. (2014)",
                                "Buizert et al. (2015)",
                                "Capron et al. (2021)",
                                "Corrick et al. (2020)")
                                 )+
  scale_linetype_manual("",values=c("Synchronized onset posterior"="solid",
                                "Synchronized onset posterior (tie-point 4 excluded)"="dashed",
                                "Unsynchronized onset posterior"="solid",
                                "Rasmussen et al. (2014)"="solid",
                                "Buizert et al. (2015)"="solid",
                                "Capron et al. (2021)"="solid",
                                "Corrick et al. (2020)"="solid",
                                "Adolphi et al. (2018)"="solid"),
                       breaks=c("Synchronized onset posterior",
                                "Synchronized onset posterior (tie-point 4 excluded)",
                                "Unsynchronized onset posterior",
                                "Adolphi et al. (2018)",
                                "Rasmussen et al. (2014)",
                                "Buizert et al. (2015)",
                                "Capron et al. (2021)",
                                "Corrick et al. (2020)")
                                    )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        # legend.text = element_text(size = 17),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.size = unit(0.8,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(0.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )


  
  

  
  ggplots[[30]] = ggl
  ggarrange(plotlist=ggplots,nrow=6,ncol=5,widths=c(6,5))
  
  # ggsave("allevents-5200x6500.eps",device=cairo_ps,width=5200,height=6500,units="px",limitsize=FALSE)
  
  
  ggl1 = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="Synchronized onset posterior",linetype="Synchronized onset posterior"))+
  geom_line(aes(x=x1,y=y1,col="Synchronized onset posterior (tie-point 4 excluded)",linetype="Synchronized onset posterior (tie-point 4 excluded)"))+
  geom_line(aes(x=x2,y=y2,col="Unsynchronized onset posterior",linetype="Unsynchronized onset posterior"))+
  geom_line(aes(x=x,y=y,col="Adolphi et al. (2018)",linetype="Adolphi et al. (2018)"))+
  scale_color_manual("",values=c("Synchronized onset posterior"="black",
                                "Synchronized onset posterior (tie-point 4 excluded)"="grey1",
                                "Unsynchronized onset posterior"="gray",
                                "Adolphi et al. (2018)"="purple"),
                       breaks=c("Synchronized onset posterior",
                                "Synchronized onset posterior (tie-point 4 excluded)",
                                "Unsynchronized onset posterior",
                                "Adolphi et al. (2018)")
                                 )+
  scale_linetype_manual("",values=c("Synchronized onset posterior"="solid",
                                "Synchronized onset posterior (tie-point 4 excluded)"="dashed",
                                "Unsynchronized onset posterior"="solid",
                                "Adolphi et al. (2018)"="solid"),
                       breaks=c("Synchronized onset posterior",
                                "Synchronized onset posterior (tie-point 4 excluded)",
                                "Unsynchronized onset posterior",
                                "Adolphi et al. (2018)")
                                    )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        # legend.text = element_text(size = 17),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.size = unit(0.8,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(0.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )
  
  ggl2 = ggplot(data.frame(x=c(1,2),y=c(2,3),x1=c(1,2),y1=c(1,2),x2=c(1,2),y2=c(1,2)),
             x3=c(1,2),y3=c(2,3),x4=c(1,2),y4=c(1,2),x5=c(1,2),y5=c(1,2),x6=c(1,2),x7=c(1,2),
             x8 = c(1,2), y8=c(1,2)) +
  geom_line(aes(x=x,y=y,col="Rasmussen et al. (2014)",linetype="Rasmussen et al. (2014)"))+
  geom_line(aes(x=x1,y=y1,col="Buizert et al. (2015)",linetype="Buizert et al. (2015)"))+
  geom_line(aes(x=x2,y=y2,col="Capron et al. (2021)",linetype="Capron et al. (2021)"))+
  geom_line(aes(x=x,y=y,col="Corrick et al. (2020)",linetype="Corrick et al. (2020)"))+
  scale_color_manual("",values=c("Rasmussen et al. (2014)"="blue",
                                "Buizert et al. (2015)"="green",
                                "Capron et al. (2021)"="red",
                                "Corrick et al. (2020)"="brown"),
                       breaks=c("Rasmussen et al. (2014)",
                                "Buizert et al. (2015)",
                                "Capron et al. (2021)",
                                "Corrick et al. (2020)")
                                 )+
  scale_linetype_manual("",values=c("Rasmussen et al. (2014)"="solid",
                                "Buizert et al. (2015)"="solid",
                                "Capron et al. (2021)"="solid",
                                "Corrick et al. (2020)"="solid"),
                       breaks=c("Adolphi et al. (2018)",
                                "Rasmussen et al. (2014)",
                                "Buizert et al. (2015)",
                                "Capron et al. (2021)",
                                "Corrick et al. (2020)")
                                    )+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(1.5, 0.5), # move the legend to the center
        legend.title = element_blank(),
        # legend.text = element_text(size = 17),
        legend.key = element_rect(fill='NA'),
        legend.key.width=unit(1,"cm"),
        # legend.key.size = unit(0.8,'cm'),
        panel.grid = element_blank(),
        # legend.spacing = unit(3,'cm'),
        # legend.spacing.y = unit(0.5,'cm'),
        panel.border = element_rect(colour = "white", fill='white', size=1)
  )
  ggplots2 = ggplots
  ggplots2[[30]] = ggl1
  ggplots2[[31]] = ggl2
  ggarrange(plotlist=ggplots2,nrow=8,ncol=4,widths=c(6,5))

  
  # ggsave("allevents2-4500x5500.eps",device=cairo_ps,width=4500,height=5500,units="px",limitsize=FALSE)
    

rownames=c()
for(i in 1:29){
  rownames=c(rownames,str_sub(event_intervals[i,2],str_locate(event_intervals[i,2],"GI-")[1]))
}
#colnames = colnames(depthstats)[1:4]
#colnames = c("name","d18O_mean","d18O_q0.025","d18O_q0.975")
depthresults = t(depthstats)[,2:4]
colnames(depthresults)=c("Z* mean", "Z* q0.025","Z* q0.975")
ageresults = t(agestats[2:4,])
colnames(ageresults)=c("Y* mean", "Y* q0.025","Y* q0.975")
allresults = cbind(depthresults,ageresults)
rownames(allresults)=rownames
latexstr = "Event & Z^* mean (m) & Z^* 95\\% CI (m) & Y^* mean (yb2k) & Y^* 95\\% CI (yb2k) \\\\ \n"
for(i in 1:29){
  latexstr = paste0(latexstr,rownames[i], "& ", format(round(allresults[i,1],2),nsmall=2)," & (", format(round(allresults[i,2],2),nsmall=2), ",
         ",format(round(allresults[i,3],2),nsmall=2),") & ", format(round(allresults[i,4],2),nsmall=2)," & (",format(round(allresults[i,5],2),nsmall=2),", ",format(round(allresults[i,6],2),nsmall=2),") \\\\ \n"
         )
}
cat(latexstr)
```



# Other stuff




To get started, see the documentation '?bremla' and the associated example.

The package includes the NGRIP/GICC05 data set 'NGRIP_d18O_and_dust_5cm' downloaded from [Centre for Ice and Climate](iceandclimate.nbi.ku.dk) at the Niels Bohr Institute of the University of Copenhagen, Denmark, and the table of stadial-interstadial events presented by [Rasmussen et al. (2014)](https://www.sciencedirect.com/science/article/pii/S0277379114003485). Also includes the tie-point presented in [Adolphi et al. (2018)](https://cp.copernicus.org/articles/14/1755/2018/) and [Muscheler et al. (2020)](https://www.cambridge.org/core/journals/radiocarbon/article/testing-and-improving-the-intcal20-calibration-curve-with-independent-records/D72D9214C47FE9441B5E730D33DCCE3D). Other data and tie-points should work as well.

Warning: The provided real data example generates several thousand simulated chronologies with individual lengths exceeding 18,000. More if synchronized chronologies is also computed. This will require a significant amount of memory. If needed, reduce the number of samples generated or free up memory before use.

## Illustration example

The data used to generate the illustrative examples in the paper is as follows.

```{r illustrationexample}
# rm(list=ls())
require(stats)
library(ggplot2)
set.seed(123)
n=800
y0 = 0
z0 = 0
phi=0.8; sigma=15
depth = z0+seq(from=1,to=n,length.out=n)

covariate = arima.sim(model=list(ar=c(0.99)),n=n)
noise = sigma*arima.sim(model=list(ar=c(phi)),n=n,sd=sqrt(1-phi^2))

dy = 10 + depth*5/n+covariate+noise
y = y0+cumsum(dy)

data=data.frame(age=c(y0,y),depth=c(z0,depth),dy=c(0,as.numeric(dy)),covariate=c(0,covariate))
#data=rbind(c(y0,z0,0,0),df)
formula=dy~ 1 + depth + covariate 
nsims = 10000

# Unsynchronized
res = bremla(formula,data,reference.label="simulated time scale",nsims=nsims,
             control.fit=list(noise="ar1"),
             x.label="Depth",
             y.label="Ensemble age - observed age",
             control.sim = list(synchronized=FALSE,
                                nsims=nsims))

library(ggplot2)
orichron = res$data$age
ggd = data.frame(depth=res$data$depth,
                 mean = res$simulation$summary$mean-orichron,
                 lower = res$simulation$summary$lower-orichron,
                 upper = res$simulation$summary$upper-orichron)
ggd1_2 = data.frame(depth=res$data$depth,
                 mean = res$simulation$summary$mean,
                 lower = res$simulation$summary$lower,
                 upper = res$simulation$summary$upper)
ggpunc = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)
ggpunc2 = ggplot(data=ggd1_2,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)
# plot(res)
#ggsave("illustrative-unsync.eps",device=cairo_ps,width=4800,height=2000,units="px")

# Fixed tie-points
ntie = 3
tiesims = matrix(NA,nrow=nsims,ncol=ntie)
tiedepths = c(100,300,600)
tieage = c(450,3000,8500)

for(i in 1:ntie){
  tiesims[,i] = rep(tieage[i],nsims)
}

res2 = tiepointsimmer(res,synchronization = list(locations=tiedepths,locations_unit="depth",
                       samples = tiesims)
               )

res2 = bremla_synchronized_simulation(res2,control.sim=list(synchronized=TRUE))

ggd = data.frame(depth=res2$data$depth,
                 mean = res2$simulation$summary_sync$mean-orichron,
                 lower = res2$simulation$summary_sync$lower-orichron,
                 upper = res2$simulation$summary_sync$upper-orichron)
ggd_2 = data.frame(depth=res2$data$depth,
                 mean = res2$simulation$summary_sync$mean,
                 lower = res2$simulation$summary_sync$lower,
                 upper = res2$simulation$summary_sync$upper)

oritie = orichron[tiedepths]
ggd2 = data.frame(depth=res2$tie_points$locations,
                  mean=res2$simulation$summary_sync$mean[tiedepths]-oritie)
ggd2_2 = data.frame(depth=res2$tie_points$locations,
                  mean=res2$simulation$summary_sync$mean[tiedepths])

ggpfix = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_point(data=ggd2,mapping=aes(x=depth,y=mean),col="magenta",size=1)
ggpfix2 = ggplot(data=ggd_2,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_point(data=ggd2_2,mapping=aes(x=depth,y=mean),col="magenta",size=1)

#plot(res)
#ggsave("illustrative-fixedsync.eps",device=cairo_ps,width=4800,height=2000,units="px")

tiemeans = c(450,3000,8500)
tiesds = c(100,500,200)
res3 = tiepointsimmer(res,synchronization = list(locations=tiedepths,
                                                locations_unit="depth",
                                                method="normal",
                                                params=list(mean=tiemeans,
                                                            sd=tiesds))
               )
res3 = bremla_synchronized_simulation(res3,control.sim=list(synchronized=TRUE))
ggd = data.frame(depth=res3$data$depth,
                 mean = res3$simulation$summary_sync$mean-orichron,
                 lower = res3$simulation$summary_sync$lower-orichron,
                 upper = res3$simulation$summary_sync$upper-orichron)
ggd_2 = data.frame(depth=res3$data$depth,
                 mean = res3$simulation$summary_sync$mean,
                 lower = res3$simulation$summary_sync$lower,
                 upper = res3$simulation$summary_sync$upper)

oritie = orichron[tiedepths]
ggd2 = data.frame(depth=res3$tie_points$locations,
                  lower=res3$simulation$summary_sync$lower[tiedepths]-oritie,
                  upper=res3$simulation$summary_sync$upper[tiedepths]-oritie)
ggd2_2 = data.frame(depth=res3$tie_points$locations,
                  lower=res3$simulation$summary_sync$lower[tiedepths],
                  upper=res3$simulation$summary_sync$upper[tiedepths])

ggprand = ggplot(data=ggd,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_segment(data=ggd2,mapping=aes(x=depth,xend=depth,y=lower,yend=upper), 
               col="magenta",size=0.7)
ggprand2 = ggplot(data=ggd_2,aes(depth))+theme_bw()+xlab("Depth")+ylab("Ensemble age - observed age")+
  geom_ribbon(aes(ymin=lower,ymax=upper),col="red",fill="red",alpha=0.3,size=0.7)+
  geom_line(aes(y=mean),col="blue",size=0.7)+
  geom_segment(data=ggd2_2,mapping=aes(x=depth,xend=depth,y=lower,yend=upper), 
               col="magenta",size=0.7)
  
#plot(res3)
ylim = range(res$simulation$summary$lower-orichron,res$simulation$summary$upper-orichron,
             res3$simulation$summary_sync$lower-orichron,res3$simulation$summary_sync$upper-orichron)
ggpunc = ggpunc + ylim(ylim) + ggtitle("(a) Unsynchronous chronologies")
ggpfix = ggpfix + ylim(ylim)+ ggtitle("(b) Synchronous chronologies: fixed tie-points")
ggprand = ggprand + ylim(ylim)+ ggtitle("(c) Synchronous chronologies: uncertain tie-points")
ggplotlist0 = c(); ggplotlist0[[1]] = ggpunc; ggplotlist0[[2]] = ggpfix; ggplotlist0[[3]] = ggprand
ggplotlist00 = ggarrange(plotlist=ggplotlist0,nrow=3,ncol=1)


ylim = range(res$simulation$summary$lower,res$simulation$summary$upper,
             res3$simulation$summary_sync$lower,res3$simulation$summary_sync$upper)
ggpunc2 = ggpunc2 + ylim(ylim) + ggtitle("(a) Unsynchronous chronologies")+ylab("Ensemble age")
ggpfix2 = ggpfix2 + ylim(ylim)+ ggtitle("(b) Synchronous chronologies: fixed tie-points")+ylab("Ensemble age")
ggprand2 = ggprand2 + ylim(ylim)+ ggtitle("(c) Synchronous chronologies: uncertain tie-points")+ylab("Ensemble age")
ggplotlist1 = c(); ggplotlist1[[1]] = ggpunc2; ggplotlist1[[2]] = ggpfix2; ggplotlist1[[3]] = ggprand2
ggplotarrange = ggarrange(plotlist=ggplotlist1,nrow=3,ncol=1)
plot(ggplotarrange)
ggsave("illustrative-all-3000x3000.eps",device=cairo_ps,width=3000,height=3000,units="px")


#ggsave("illustrative-sync.eps",device=cairo_ps,width=4800,height=2000,units="px")

```

## Simulation example

To verify our model we can test it on simulated data where the true parameters are known.

```{r simex}
#rm(list=ls())
require(stats)
library(ggplot2)
set.seed(123)
n=1000
y0 = 0
z0 = 0
phi=0.8; sigma=3

depth = z0+seq(from=1,1000,length.out=1000)
depth2 = depth^2#/z0 #normalize for stability

dnoise = sigma*arima.sim(n=n,model=list(ar=c(phi)),sd=sqrt(1-phi^2))
proxy = arima.sim(n=n,model=list(ar=0.9),sd=sqrt(1-0.9^2))

truevals = c(sigma,phi,       0.5, 10, 0.01, 20, 0.02, 0, 0.03)
namevals = c("\\sigma","\\phi","b_w","a_1","b_1","a_2","b_2","a_3","b_3")

events=list(locations=c(1,250,750,1000))
a1 = c(rep(1,249),numeric(751))
a2 = c(numeric(249),rep(1,500),numeric(251))
a3 = c(numeric(749),rep(1,251))
c1 = c(depth[1:249],numeric(751))
c2 = c(numeric(249),depth[250:749],numeric(251))
c3 = c(numeric(749),depth[750:1000])
dy = dnoise + a1*truevals[4]+a2*truevals[6]+a3*truevals[8]+c1*truevals[5]+
  c2*truevals[7]+c3*truevals[9] + proxy*truevals[3]
plot(dy)
age = y0+cumsum(dy)
df=data.frame(age=age,dy=as.numeric(dy),proxy=as.numeric(proxy),depth=depth); data=rbind(c(y0,z0,NA,NA),df)
formula=dy~-1+proxy#+depth2
nsims = 10000
synchronization = list(locations = c(200,400,800),locations_unit="index",method="gauss", nsims=nsims,params=list(mean=c(2200,6800,19000),sd=c(10,50,60)))
res = bremla(formula,data,reference.label="simulated time scale",nsims=nsims,
             print.progress=TRUE,
             events=list(locations=c(1,250,750,1000),locations_unit="index"),
             control.fit=list(noise="ar1"),
             synchronization=synchronization,
             control.sim = list(synchronized=2,
                                nsims=nsims))
par(mfrow=c(1,2))
plot(res$fitting$inla$hyperparameters$posteriors$sigma_epsilon,type="l",xlab=expression(sigma),ylab="Density",main=expression(paste("(a) Posterior distribution of ",sigma)))
abline(v=res$fitting$inla$hyperparameters$results$sigma_epsilon$mean,lwd=1.5)
abline(v=c(res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.025,
           res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.975),lwd=1.5,col="red")
plot(res$fitting$inla$hyperparameters$posteriors$phi,type="l",xlab=expression(phi),ylab="Density",main=expression(paste("(b) Posterior distribution of ",phi)))
abline(v=res$fitting$inla$hyperparameters$results$phi$mean,lwd=1.5)
abline(v=c(res$fitting$inla$hyperparameters$results$phi$quant0.025,
           res$fitting$inla$hyperparameters$results$phi$quant0.975),lwd=1.5,col="red")
par(mfrow=c(1,1))
#plot results
  
  dsims = colDiffs(rbind(matrix(rep(res$initial$age,ncol(res$simulation$age)),nrow=1), res$simulation$age))
  dmeans = rowMeans(dsims)
  dsd = rowSds(dsims)
ggd = data.frame(y = res$data$dy,depth=res$data$depth,
                   mean=dmeans,
                   lower = dmeans-1.96*dsd,
                   upper = dmeans+1.96*dsd)
  ggp = ggplot(data=ggd,aes(x=depth)) + theme_bw()+ #xlim(rev(range(results$data$depth)))+
    geom_line(aes(y=y),col="gray")+
    geom_line(aes(y=mean),col="blue",size=0.8)+
    geom_ribbon(aes(ymin=lower,ymax=upper),color="red",alpha=0,size=0.8)+
    xlab("Depth (m)")+ylab("Layers per 5cm")+ggtitle("(a) Fitted layer increment model")
  
  ggp
  
  ggd2 = data.frame(mean=res$simulation$summary_sync$mean-res$data$age,
                    lower=res$simulation$summary_sync$lower-res$data$age,
                    upper=res$simulation$summary_sync$upper-res$data$age,
                    depth=res$data$depth
                    )
  
 reference=res$original.chron$age[1+1:n]
 reftie = reference[res$tie_points$locations_indexes]
ggdtie = data.frame(mean=synchronization$params$mean-reftie,
                    upper=synchronization$params$mean+1.96*synchronization$params$sd-reftie,
                    lower=synchronization$params$mean-1.96*synchronization$params$sd-reftie,
                    locations = res$data$depth[synchronization$locations])
ggp2 = ggplot(data=ggd2,aes(x=depth)) + theme_bw()+
  geom_ribbon(aes(ymin=lower,ymax=upper),color="red",fill="red",alpha=0.3)+
  geom_line(aes(y=mean),color="blue") +
  geom_linerange(data=ggdtie,aes(x=locations,ymin=lower,ymax=upper),color="magenta")+
  xlab("Depth (m)") + ylab("Deviation from simulated reference (years)")+
  ggtitle("(b) Simulated chronologies")

ggp2

ggarrange(ggp,ggp2,nrow=2)

library(gridExtra)
# ggsave("fitdiffsim-5500x4000.eps", device=cairo_ps,width=5500,height=4000,units="px",dpi=500,limitsize=FALSE,arrangeGrob(ggp,ggp2))
dig=3
str = ""
str = paste0(str, " $",namevals[1],"$ & ",truevals[1]," & ", format(res$fitting$inla$hyperparameters$results$sigma_epsilon$mean,digits=dig,scientific=FALSE)," & (",format(res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.025,digits=dig,scientific=FALSE), ", ",format(res$fitting$inla$hyperparameters$results$sigma_epsilon$quant0.975,difits=dig,scientific=FALSE),") \\\\ \n")

str = paste0(str, " $",namevals[2],"$ & ",truevals[2]," & ", format(res$fitting$inla$hyperparameters$results$phi$mean,digits=dig,scientific=FALSE)," & (",format(res$fitting$inla$hyperparameters$results$phi$quant0.025,digits=dig,scientific=FALSE), ", ",format(res$fitting$inla$hyperparameters$results$phi$quant0.975,difits=dig,scientific=FALSE),") \\\\ \n")

for(i in 1:length(res$fitting$inla$fit$summary.fixed$mean)){
  str=paste0(str, " $",namevals[i+2],"$ & ",truevals[i+2], " & ",format(res$fitting$inla$fit$summary.fixed$mean[i],digits=dig,scientific=FALSE), " & (",
             format(res$fitting$inla$fit$summary.fixed$`0.025quant`[i],digits=dig,scientific=FALSE),", ",
             format(res$fitting$inla$fit$summary.fixed$`0.975quant`[i],digits=dig,scientific=FALSE),") \\\\ \n")
}
cat(str)  


```

## Real data example
This is a real data example which produces 5000 simulations from a synchronized time scale.
```{r example, message=FALSE, warning=FALSE, include=TRUE}
require(INLA)
library(bremla)
data("event_intervals")
data("events_rasmussen")
data("NGRIP_5cm")
age = NGRIP_5cm$age
depth = NGRIP_5cm$depth
depth2 = depth^2/depth[1]^2 #normalize for stability
proxy = NGRIP_5cm$d18O
data = data.frame(age=age,dy=c(NA,diff(age)),depth=depth,depth2=depth2,proxy=proxy)
formula = dy~-1+depth2
events=list(locations = events_rasmussen$depth,
            locations_unit="depth",degree=1)
results = bremla(formula,data,reference.label="GICC05",
                nsims=nsims,
                events=events,
                synchronization=list(method="adolphi"),
                control.fit=list(method="inla"),
                control.sim=list(synchronized=TRUE) )
summary(results)
```

```{r plot, message=FALSE, eval=TRUE, echo=FALSE}
require(ggplot2)
free_indexes = results$tie_points$free_indexes
tie_indexes = results$tie_points$tie_indexes
ageref_free = results$data$age[free_indexes]
ageref_tie = results$data$age[tie_indexes]
fullpd = data.frame(depth = results$data$depth[free_indexes],
                medians=results$simulation$summary_sync$median[free_indexes]-ageref_free,
                lower=results$simulation$summary_sync$lower[free_indexes]-ageref_free,
                upper=results$simulation$summary_sync$upper[free_indexes]-ageref_free)
gg2 = ggplot(data=fullpd,aes(x=depth)) +
geom_line(aes(y=rep(0,nrow(fullpd))),color="blue",linetype="dotted",size=0.2)+
theme_bw()+ylab("Estimated age - reference (years)")+
xlab("NGRIP depth (m)")
gg2 = gg2+geom_line(aes(y=medians))+
geom_ribbon(aes(ymin=.data$lower,ymax=.data$upper),color="red",fill="red",alpha=0.3)
gg2 = gg2 + geom_segment(data=data.frame(depth=results$data$depth[tie_indexes],                                   median=results$simulation$summary_sync$median[tie_indexes]-ageref_tie,                         lower=results$simulation$summary_sync$lower[tie_indexes]-ageref_tie,
                   upper=results$simulation$summary_sync$upper[tie_indexes]-ageref_tie),
                   aes(x=.data$depth,y=.data$lower,xend=.data$depth,yend=.data$upper),
                   col="magenta")
print(gg2)
```   

## Attribution

This code is associated and written for the papers Myrvoll-Nilsen et al. (2022) and Myrvoll-Nilsen et al. (202x) mentioned above. Feel free to use the code, but please cite the accompanying papers.

## License

The code in this repository is made available under the terms of the GNU (version >=2) License. For details, see LICENSE.md file.
